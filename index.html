<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowtrack | Crypto Derivatives Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg: #0a0e17;
            --bg-secondary: #0d1321;
            --panel: #111827;
            --panel-hover: #1a2332;
            --border: #1e2a3b;
            --border-light: #2d3a4f;
            --text: #e5e7eb;
            --text-muted: #9ca3af;
            --text-dim: #6b7280;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.2);
            --good: #10b981;
            --good-bg: rgba(16, 185, 129, 0.12);
            --warn: #f59e0b;
            --warn-bg: rgba(245, 158, 11, 0.12);
            --bad: #ef4444;
            --bad-bg: rgba(239, 68, 68, 0.12);
            --purple: #8b5cf6;
            --cyan: #06b6d4;
            --orange: #f97316;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }
        
        /* Navigation */
        .nav {
            background: rgba(13, 19, 33, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-img {
            height: 32px;
            width: auto;
            filter: invert(1) brightness(1.1);
        }
        
        .nav-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--good);
            animation: pulse 2s infinite;
        }
        
        .status-dot.error { background: var(--bad); }
        .status-dot.loading { background: var(--warn); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .refresh-btn {
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover { background: var(--panel-hover); border-color: var(--border-light); }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Market Overview Bar */
        .market-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 900px) {
            .market-overview { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 500px) {
            .market-overview { grid-template-columns: 1fr; }
        }
        
        .market-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
        }
        
        .market-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .market-value {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .market-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .market-change.positive { color: var(--good); }
        .market-change.negative { color: var(--bad); }
        .market-subtitle { color: var(--text-muted); font-size: 11px; margin-top: 2px; }
        
        /* Grid */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
        .grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; }
        
        @media (max-width: 1200px) {
            .grid-4, .grid-5 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 800px) {
            .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; }
        }
        
        /* Cards */
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            transition: all 0.2s;
        }
        
        .card:hover { border-color: var(--border-light); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 100px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .badge-good { background: var(--good-bg); color: var(--good); }
        .badge-warn { background: var(--warn-bg); color: var(--warn); }
        .badge-bad { background: var(--bad-bg); color: var(--bad); }
        .badge-neutral { background: rgba(107, 114, 128, 0.2); color: var(--text-muted); }
        
        .card-value {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }
        
        .card-value.lg { font-size: 36px; }
        
        .card-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Summary Row */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .summary-row { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 700px) {
            .summary-row { grid-template-columns: repeat(2, 1fr); }
        }
        
        .summary-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        
        .summary-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 800;
        }
        
        .summary-change {
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Section */
        .section {
            margin-bottom: 32px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.3px;
        }
        
        .section-divider {
            height: 1px;
            background: linear-gradient(to right, var(--border), transparent);
            margin: 32px 0;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .chart-container.tall { height: 400px; }
        
        /* Funding Rate Heatmap */
        .funding-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .funding-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .funding-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .funding-symbol {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .funding-rate {
            font-size: 14px;
            font-weight: 800;
        }
        
        .funding-rate.positive { color: var(--bad); }
        .funding-rate.negative { color: var(--good); }
        .funding-rate.neutral { color: var(--text-muted); }
        
        .funding-apr {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
        }
        
        /* Funding Meter */
        .funding-meter {
            height: 20px;
            background: linear-gradient(90deg, var(--good) 0%, var(--bg-secondary) 50%, var(--bad) 100%);
            border-radius: 10px;
            position: relative;
            margin: 16px 0;
        }
        
        .funding-pointer {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 28px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            transform: translateX(-50%);
            transition: left 0.5s ease;
        }
        
        .funding-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
        }
        
        /* Long/Short Ratio Bar */
        .ls-bar {
            height: 16px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            margin: 12px 0;
        }
        
        .ls-long {
            background: var(--good);
            transition: width 0.5s;
        }
        
        .ls-short {
            background: var(--bad);
            transition: width 0.5s;
        }
        
        .ls-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Fear & Greed Meter */
        .fg-meter {
            height: 16px;
            background: linear-gradient(90deg, #dc2626 0%, #f59e0b 25%, #eab308 50%, #84cc16 75%, #22c55e 100%);
            border-radius: 8px;
            position: relative;
            margin: 16px 0;
        }
        
        .fg-pointer {
            position: absolute;
            top: -6px;
            width: 4px;
            height: 28px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            transform: translateX(-50%);
            transition: left 0.5s ease;
        }
        
        .fg-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
        }
        
        /* Signal Box */
        .signal-box {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-top: 12px;
        }
        
        .signal-icon { font-size: 24px; }
        .signal-text { flex: 1; }
        .signal-title { font-size: 13px; font-weight: 700; }
        .signal-desc { font-size: 11px; color: var(--text-muted); }
        
        /* OI Bar */
        .oi-bar {
            height: 28px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            margin: 12px 0;
        }
        
        .oi-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            transition: all 0.3s;
        }
        
        .oi-segment.btc { background: var(--accent); }
        .oi-segment.eth { background: var(--cyan); }
        .oi-segment.others { background: var(--orange); }
        
        /* Loading & Error States */
        .loading-text {
            color: var(--text-muted);
            font-size: 13px;
        }
        
        .error-text {
            color: var(--bad);
            font-size: 12px;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 24px;
            color: var(--text-dim);
            font-size: 12px;
            border-top: 1px solid var(--border);
            margin-top: 32px;
        }
        
        footer a {
            color: var(--accent);
            text-decoration: none;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border: none;
            background: none;
            transition: all 0.2s;
            text-align: center;
        }
        
        .tab-btn:hover { 
            color: var(--text); 
            background: rgba(255,255,255,0.03);
        }
        
        .tab-btn.active { 
            background: var(--accent); 
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Time Selector */
        .time-selector {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 3px;
            border-radius: 6px;
        }
        
        .time-btn {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border: none;
            background: none;
            transition: all 0.2s;
        }
        
        .time-btn:hover { color: var(--text); }
        .time-btn.active { background: var(--panel); color: var(--text); }
        
        /* TradingView Charts */
        .tradingview-widget-container {
            border-radius: 0 0 14px 14px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <div class="logo">
                <img src="logo.webp" alt="Flowtrack" class="logo-img" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     id="logoImg">
                <span style="display:none; font-size: 24px; font-weight: 800; color: white;" id="logoText">Flowtrack</span>
            </div>
            
            <div class="nav-status">
                <div class="status-pill">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="lastUpdate">Loading...</span>
                </div>
                <button class="refresh-btn" onclick="exportWeeklyReport()" style="background: linear-gradient(135deg, #10b981, #059669);">
                    üìÑ Export Report
                </button>
                <button class="refresh-btn" onclick="refreshAllData()" id="refreshBtn">
                    ‚Üª Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Market Overview (Top) -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üåê Market Overview</div>
            </div>
            <div class="market-overview">
                <div class="market-card">
                    <div class="market-label">Total Market Cap</div>
                    <div class="market-value" id="totalMcap">--</div>
                    <div class="market-change" id="mcapChange">--</div>
                </div>
                <div class="market-card">
                    <div class="market-label">24H Volume</div>
                    <div class="market-value" id="totalVol">--</div>
                    <div class="market-subtitle">Global trading volume</div>
                </div>
                <div class="market-card">
                    <div class="market-label">BTC Price</div>
                    <div class="market-value" id="btcPrice">--</div>
                    <div class="market-change" id="btcChange">--</div>
                </div>
                <div class="market-card">
                    <div class="market-label">ETH Price</div>
                    <div class="market-value" id="ethPrice">--</div>
                    <div class="market-change" id="ethChange">--</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('derivatives')">Derivatives Data</button>
            <button class="tab-btn" onclick="switchTab('hyperliquid')">Hyperliquid</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active">

        <!-- Price Charts Section - BTC/ETH -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Price Charts</div>
            </div>
            <div class="grid-2">
                <!-- BTC/USD Chart -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">Bitcoin (BTC/USD)</div>
                        <div class="card-subtitle">Weekly ‚Ä¢ Full History ‚Ä¢ INDEX</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 400px;">
                        <div id="btc-usd-chart" style="height: 100%;"></div>
                    </div>
                </div>
                
                <!-- ETH/USD Chart -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">Ethereum (ETH/USD)</div>
                        <div class="card-subtitle">Weekly ‚Ä¢ Full History ‚Ä¢ INDEX</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 400px;">
                        <div id="eth-usd-chart" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Market Structure Charts -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Market Structure</div>
            </div>
            <div class="grid-2">
                <!-- BTC Dominance Chart -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">Bitcoin Dominance (BTC.D)</div>
                        <div class="card-subtitle">Weekly Timeframe ‚Ä¢ CRYPTOCAP</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 400px;">
                        <div id="btc-dominance-chart" style="height: 100%;"></div>
                    </div>
                </div>
                
                <!-- ETH/BTC Chart -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">ETH/BTC Ratio</div>
                        <div class="card-subtitle">Weekly Timeframe ‚Ä¢ Binance</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 400px;">
                        <div id="eth-btc-chart" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cross-Asset Comparison Chart -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Cross-Asset Performance</div>
            </div>
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 16px 18px 8px 18px;">
                    <div class="card-title">BTC vs ETH vs S&P 500 vs NASDAQ (% Change)</div>
                    <div class="card-subtitle">7 Days ‚Ä¢ Hourly ‚Ä¢ Percentage Scale</div>
                </div>
                <div class="tradingview-widget-container" style="height: 500px;">
                    <div id="cross-asset-chart" style="height: 100%;"></div>
                </div>
            </div>
            
            <!-- Crypto Leaders Comparison -->
            <div class="card" style="padding: 0; overflow: hidden; margin-top: 16px;">
                <div style="padding: 16px 18px 8px 18px;">
                    <div class="card-title">Crypto Leaders (% Change)</div>
                    <div class="card-subtitle">BTC ‚Ä¢ ETH ‚Ä¢ SOL ‚Ä¢ HYPE ‚Ä¢ 7 Days Hourly</div>
                </div>
                <div class="tradingview-widget-container" style="height: 500px;">
                    <div id="crypto-leaders-chart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        
        <!-- Global Liquidity Section -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Global Liquidity</div>
            </div>
            
            <!-- Global Liquidity vs Bitcoin Chart -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">US Net Liquidity vs Bitcoin</div>
                        <div class="card-subtitle">Fed Balance Sheet ‚àí RRP ‚àí TGA (Trillions USD)</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="period-btn" data-liquidity-period="1y">1Y</button>
                        <button class="period-btn" data-liquidity-period="2y">2Y</button>
                        <button class="period-btn" data-liquidity-period="3y">3Y</button>
                        <button class="period-btn active" data-liquidity-period="all">ALL</button>
                    </div>
                </div>
                <div style="height: 400px; margin-top: 12px;">
                    <canvas id="liquidity-btc-chart"></canvas>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        <strong style="color: var(--text);">Interpretation:</strong> Rising liquidity ‚Üí Bullish for risk assets. 
                        Watch RRP drawdowns (adds liquidity) and TGA buildups (drains liquidity). 
                        <span style="color: var(--cyan);">‚óè</span> Net Liquidity &nbsp;
                        <span style="color: #f7931a;">‚óè</span> Bitcoin
                    </div>
                </div>
            </div>
            
            <div class="grid-2" style="margin-top: 16px;">
                <!-- Fed Balance Sheet -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">Fed Balance Sheet (WALCL)</div>
                        <div class="card-subtitle">US Federal Reserve Total Assets ‚Ä¢ Weekly</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 350px;">
                        <div id="fed-balance-sheet-chart" style="height: 100%;"></div>
                    </div>
                </div>
                
                <!-- Treasury General Account -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">Treasury General Account (TGA)</div>
                        <div class="card-subtitle">US Treasury Cash Balance ‚Ä¢ Drains Liquidity When Rising</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 350px;">
                        <div id="tga-chart" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="grid-2" style="margin-top: 16px;">
                <!-- Reverse Repo -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">Reverse Repo Facility (RRP)</div>
                        <div class="card-subtitle">Overnight Reverse Repurchases ‚Ä¢ Adds Liquidity When Falling</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 350px;">
                        <div id="rrp-chart" style="height: 100%;"></div>
                    </div>
                </div>
                
                <!-- US M2 Money Supply -->
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 16px 18px 8px 18px;">
                        <div class="card-title">M2 Money Supply</div>
                        <div class="card-subtitle">Broad US Money Supply ‚Ä¢ Monthly</div>
                    </div>
                    <div class="tradingview-widget-container" style="height: 350px;">
                        <div id="m2-chart" style="height: 100%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Liquidity Components Summary -->
            <div class="card" style="margin-top: 16px;">
                <div class="card-header">
                    <div class="card-title">Liquidity Components Reference</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 12px;">
                    <div style="padding: 14px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid var(--accent);">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Fed Balance Sheet</div>
                        <div style="font-size: 13px; font-weight: 600; color: var(--text);">WALCL</div>
                        <div style="font-size: 11px; color: var(--good); margin-top: 4px;">‚Üë Adds Liquidity</div>
                    </div>
                    <div style="padding: 14px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid var(--bad);">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Reverse Repo (RRP)</div>
                        <div style="font-size: 13px; font-weight: 600; color: var(--text);">RRPONTSYD</div>
                        <div style="font-size: 11px; color: var(--bad); margin-top: 4px;">‚Üë Drains Liquidity</div>
                    </div>
                    <div style="padding: 14px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid var(--bad);">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Treasury Account (TGA)</div>
                        <div style="font-size: 13px; font-weight: 600; color: var(--text);">WTREGEN</div>
                        <div style="font-size: 11px; color: var(--bad); margin-top: 4px;">‚Üë Drains Liquidity</div>
                    </div>
                    <div style="padding: 14px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid var(--cyan);">
                        <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">M2 Money Supply</div>
                        <div style="font-size: 13px; font-weight: 600; color: var(--text);">M2SL</div>
                        <div style="font-size: 11px; color: var(--good); margin-top: 4px;">‚Üë Adds Liquidity</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stablecoin Section -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Stablecoin Market</div>
            </div>
            <div class="grid-4" style="margin-bottom: 16px;">
                <div class="market-card">
                    <div class="market-label">Total Stablecoin Supply</div>
                    <div class="market-value" id="stableTotalMcap">--</div>
                    <div class="market-change" id="stableTotalChange">--</div>
                </div>
                <div class="market-card">
                    <div class="market-label">USDT (Tether)</div>
                    <div class="market-value" id="stableUSDT">--</div>
                    <div class="market-subtitle" id="stableUSDTDom">-- dominance</div>
                </div>
                <div class="market-card">
                    <div class="market-label">USDC (Circle)</div>
                    <div class="market-value" id="stableUSDC">--</div>
                    <div class="market-subtitle" id="stableUSDCDom">-- dominance</div>
                </div>
                <div class="market-card">
                    <div class="market-label">Other Stables</div>
                    <div class="market-value" id="stableOthers">--</div>
                    <div class="market-subtitle">DAI, USDS, USDe, etc.</div>
                </div>
            </div>
            
            <!-- Stablecoin Dominance Bar -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Stablecoin Market Share</div>
                </div>
                <div class="stablecoin-bar" style="height: 32px; border-radius: 8px; overflow: hidden; display: flex; margin: 12px 0;">
                    <div id="stableBarUSDT" style="background: #26A17B; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: white; transition: all 0.5s;">USDT</div>
                    <div id="stableBarUSDC" style="background: #2775CA; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: white; transition: all 0.5s;">USDC</div>
                    <div id="stableBarDAI" style="background: #F5AC37; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: white; transition: all 0.5s;">DAI</div>
                    <div id="stableBarOther" style="background: #6b7280; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: white; transition: all 0.5s;">Other</div>
                </div>
                
                <!-- Top Stablecoins Table -->
                <div style="margin-top: 16px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border);">
                                <th style="text-align: left; padding: 8px 12px; color: var(--text-muted); font-weight: 600;">Name</th>
                                <th style="text-align: right; padding: 8px 12px; color: var(--text-muted); font-weight: 600;">Symbol</th>
                                <th style="text-align: right; padding: 8px 12px; color: var(--text-muted); font-weight: 600;">Market Cap</th>
                                <th style="text-align: right; padding: 8px 12px; color: var(--text-muted); font-weight: 600;">Dominance</th>
                            </tr>
                        </thead>
                        <tbody id="stablecoinTable">
                            <tr><td colspan="4" style="padding: 16px; text-align: center; color: var(--text-muted);">Loading stablecoin data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Stablecoin Historical Chart -->
            <div class="card" style="margin-top: 16px;">
                <div class="card-header">
                    <div class="card-title">Total Stablecoin Supply History</div>
                    <div class="time-selector">
                        <button class="time-btn" onclick="updateStablecoinChart('30')">30D</button>
                        <button class="time-btn" onclick="updateStablecoinChart('90')">90D</button>
                        <button class="time-btn" onclick="updateStablecoinChart('365')">1Y</button>
                        <button class="time-btn active" onclick="updateStablecoinChart('all')">ALL</button>
                    </div>
                </div>
                <div class="chart-container tall">
                    <canvas id="stablecoinChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Fear & Greed Section -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Market Sentiment</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">BTC Price vs Fear & Greed Index</div>
                        <div class="card-subtitle">Historical sentiment correlation ‚Ä¢ Data from Alternative.me</div>
                    </div>
                    <div class="time-selector">
                        <button class="time-btn" onclick="updateFearGreedChart(90)">3M</button>
                        <button class="time-btn active" onclick="updateFearGreedChart(365)">1Y</button>
                        <button class="time-btn" onclick="updateFearGreedChart(730)">2Y</button>
                    </div>
                </div>
                <div class="chart-container tall" style="position: relative;">
                    <canvas id="fearGreedHistoryChart"></canvas>
                    <div id="fearGreedLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div style="font-size: 12px; color: var(--text-muted);">Loading Fear & Greed data...</div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        <strong style="color: var(--text);">Key Insight:</strong> Extreme Fear (0-25) often signals buying opportunities. 
                        Extreme Greed (75-100) may indicate overheated conditions. 
                        <span style="color: #f7931a;">‚óè</span> BTC Price &nbsp;
                        <span style="color: #4ade80;">‚óè</span> Fear & Greed Index
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Altcoin Breadth Section -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">Market Breadth</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Altcoin Breadth: % Above 200 DMA</div>
                        <div class="card-subtitle">Percentage of top 50 altcoins trading above their 200-day moving average</div>
                    </div>
                    <div id="breadthValue" style="font-size: 24px; font-weight: 700; color: var(--accent);">--</div>
                </div>
                <div class="chart-container tall" style="position: relative;">
                    <canvas id="altcoinBreadthChart"></canvas>
                    <div id="breadthLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div style="font-size: 12px; color: var(--text-muted);">Calculating altcoin breadth...</div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(74, 222, 128, 0.1); border-radius: 8px; border-left: 3px solid #4ade80;">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        <strong style="color: var(--text);">Interpretation:</strong> High breadth (>75%) = broad participation, bullish conditions. 
                        Low breadth (<25%) = narrow market, potential capitulation or early recovery.
                        Currently analyzing top 50 altcoins by market cap.
                    </div>
                </div>
            </div>
        </div>

        </div><!-- END DASHBOARD TAB -->

        <!-- DERIVATIVES DATA TAB -->
        <div id="tab-derivatives" class="tab-content">
        
        <div class="section">
            <div class="section-header">
                <div class="section-title">Derivatives Market Data</div>
            </div>
            
            <!-- Coinalyze Multi-Panel Chart -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <div>
                        <div class="card-title">BTC Price vs Funding Rate vs Open Interest</div>
                        <div class="card-subtitle">Aggregated data across all exchanges ‚Ä¢ Daily timeframe ‚Ä¢ Data from Coinalyze</div>
                    </div>
                    <div class="time-selector">
                        <button class="time-btn" onclick="updateCoinalyzeChart(90)">3M</button>
                        <button class="time-btn" onclick="updateCoinalyzeChart(180)">6M</button>
                        <button class="time-btn active" onclick="updateCoinalyzeChart(365)">1Y</button>
                        <button class="time-btn" onclick="updateCoinalyzeChart(730)">2Y</button>
                    </div>
                </div>
                
                <!-- BTC Price Panel -->
                <div style="height: 200px; position: relative; border-bottom: 1px solid var(--border);">
                    <div style="position: absolute; top: 8px; left: 12px; font-size: 11px; color: var(--text-muted); z-index: 10;">BTC/USD</div>
                    <canvas id="coinalyzePriceChart"></canvas>
                </div>
                
                <!-- Funding Rate Panel -->
                <div style="height: 120px; position: relative; border-bottom: 1px solid var(--border);">
                    <div style="position: absolute; top: 8px; left: 12px; font-size: 11px; color: var(--text-muted); z-index: 10;">Aggregated Funding Rate (Global AVG)</div>
                    <canvas id="coinalyzeFundingChart"></canvas>
                </div>
                
                <!-- Open Interest Panel -->
                <div style="height: 120px; position: relative;">
                    <div style="position: absolute; top: 8px; left: 12px; font-size: 11px; color: var(--text-muted); z-index: 10;">Aggregated Open Interest (USD)</div>
                    <canvas id="coinalyzeOIChart"></canvas>
                </div>
                
                <div id="coinalyzeLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none;">
                    <div style="font-size: 14px; color: var(--text-muted);">Loading Coinalyze data...</div>
                </div>
                
                <div id="coinalyzeError" style="display: none; padding: 20px; text-align: center;">
                    <div style="color: var(--bad); font-size: 13px;">Failed to load Coinalyze data</div>
                    <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Check API key or try refreshing</div>
                </div>
            </div>

        <!-- OI Dominance Chart -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <div>
                    <div class="card-title">Open Interest Dominance</div>
                    <div class="card-subtitle">BTC vs ETH vs Others ‚Ä¢ Data from Coinalyze</div>
                </div>
                <div class="time-selector">
                    <button class="time-btn" onclick="updateOIDominanceChart(180)">6M</button>
                    <button class="time-btn" onclick="updateOIDominanceChart(365)">1Y</button>
                    <button class="time-btn active" onclick="updateOIDominanceChart(730)">2Y</button>
                </div>
            </div>
            <div class="chart-container tall" style="position: relative;">
                <canvas id="oiDominanceChart"></canvas>
                <div id="oiDominanceLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                    <div style="font-size: 12px; color: var(--text-muted);">Loading dominance data...</div>
                </div>
            </div>
        </div>
        
        </div><!-- Close section -->
        </div><!-- END DERIVATIVES TAB -->

        <!-- HYPERLIQUID TAB -->
        <div id="tab-hyperliquid" class="tab-content">
        
        <div class="section">
            <div class="section-header">
                <div class="section-title">Hyperliquid Analytics</div>
            </div>
            
            <!-- HYPE Price Chart -->
            <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 20px;">
                <div style="padding: 16px 18px 8px 18px;">
                    <div class="card-title">HYPE/USDT Price</div>
                    <div class="card-subtitle">Daily Timeframe ‚Ä¢ Bybit Perpetual</div>
                </div>
                <div class="tradingview-widget-container" style="height: 400px;">
                    <div id="hype-chart" style="height: 100%;"></div>
                </div>
            </div>
            
                <!-- Perp Protocol Comparison (using CoinGecko) -->
            <div class="grid-2" style="margin-bottom: 20px;">
                <!-- Perp Volume Comparison -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Perp Volume Comparison</div>
                            <div class="card-subtitle">24H volume across DEX perps ‚Ä¢ CoinGecko Data</div>
                        </div>
                    </div>
                    <div class="chart-container tall" style="position: relative;">
                        <canvas id="artemisVolumeChart"></canvas>
                        <div id="artemisVolumeLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted);">Loading Artemis data...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Open Interest Comparison -->
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Open Interest Comparison</div>
                            <div class="card-subtitle">Current OI across DEX perps ‚Ä¢ CoinGecko Data</div>
                        </div>
                    </div>
                    <div class="chart-container tall" style="position: relative;">
                        <canvas id="artemisOIChart"></canvas>
                        <div id="artemisOILoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 12px; color: var(--text-muted);">Loading Artemis data...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- HYPE Token Analytics -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <div>
                        <div class="card-title">HYPE Price vs Protocol Fees (30D Rolling)</div>
                        <div class="card-subtitle">Revenue correlation with token price ‚Ä¢ Data from DefiLlama</div>
                    </div>
                    <div class="time-selector">
                        <button class="time-btn" onclick="updateHypeFeesChart(90)">3M</button>
                        <button class="time-btn active" onclick="updateHypeFeesChart(180)">6M</button>
                        <button class="time-btn" onclick="updateHypeFeesChart(365)">1Y</button>
                    </div>
                </div>
                <div class="chart-container tall" style="position: relative;">
                    <canvas id="hypeFeesChart"></canvas>
                    <div id="hypeFeesLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div style="font-size: 12px; color: var(--text-muted);">Loading fees data...</div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(74, 222, 128, 0.1); border-radius: 8px; border-left: 3px solid var(--good);">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        <strong style="color: var(--text);">Interpretation:</strong> Rising fees with flat/falling price = potential value opportunity. 
                        <span style="color: #4ade80;">‚óè</span> HYPE Price &nbsp;
                        <span style="color: #f59e0b;">‚óè</span> 30D Rolling Fees
                    </div>
                </div>
            </div>
            
            <!-- P/S Ratio Chart -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <div>
                        <div class="card-title">HYPE Price-to-Sales Ratio</div>
                        <div class="card-subtitle">FDV / Annualized Fees ‚Ä¢ Lower = Cheaper valuation</div>
                    </div>
                </div>
                <div class="chart-container tall" style="position: relative;">
                    <canvas id="hypePSChart"></canvas>
                    <div id="hypePSLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <div style="font-size: 12px; color: var(--text-muted);">Loading P/S data...</div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="font-size: 12px; color: var(--text-muted);">
                        <strong style="color: var(--text);">Interpretation:</strong> P/S below 20 generally considered cheap for DeFi protocols. 
                        Compare to dYdX (~30-50), GMX (~15-25). Lower P/S = more revenue per $ of valuation.
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats Row -->
            <div class="grid-2">
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Current P/S Ratio</div>
                    <div style="font-size: 28px; font-weight: 800; color: var(--cyan);" id="currentPS">--</div>
                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">FDV / Ann. Fees</div>
                </div>
                
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">30D Fees</div>
                    <div style="font-size: 28px; font-weight: 800; color: var(--orange);" id="thirtyDayFees">--</div>
                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">Protocol Revenue</div>
                </div>
                
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Annualized Fees</div>
                    <div style="font-size: 28px; font-weight: 800; color: var(--good);" id="annualizedFees">--</div>
                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">30D √ó 12</div>
                </div>
                
                <div class="card" style="text-align: center; padding: 20px;">
                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Market Cap (FDV)</div>
                    <div style="font-size: 28px; font-weight: 800; color: var(--accent);" id="hypeFDV">--</div>
                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">Fully Diluted</div>
                </div>
            </div>
        </div>
        
        </div><!-- END HYPERLIQUID TAB -->

    </div>

    <footer>
        <p><strong>FLOWTRACK</strong> ‚Äî Crypto Derivatives Intelligence</p>
        <p style="margin-top: 6px;">Data from Binance Futures API, CoinGecko, Alternative.me, TradingView</p>
        <p style="margin-top: 6px;">Auto-refreshes every 60 seconds ‚Ä¢ Not financial advice</p>
    </footer>
    
    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // ==================== CONFIGURATION ====================
        const BINANCE_FAPI = 'https://fapi.binance.com/fapi/v1';
        const COINGECKO_API = 'https://api.coingecko.com/api/v3';
        const FEAR_GREED_API = 'https://api.alternative.me/fng';
        
        // Top perpetual contracts to track
        const TOP_PERPS = [
            'BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'BNBUSDT', 'XRPUSDT',
            'DOGEUSDT', 'ADAUSDT', 'AVAXUSDT', 'DOTUSDT', 'LINKUSDT',
            'MATICUSDT', 'LTCUSDT', 'ATOMUSDT', 'UNIUSDT', 'XLMUSDT',
            'NEARUSDT', 'APTUSDT', 'ARBUSDT', 'OPUSDT', 'SUIUSDT'
        ];
        
        let fundingChart = null;
        let oiDominanceChart = null;
        window.oiDominanceChart = null;
        let oiDominanceData = { btc: [], eth: [], others: [] };
        let fundingData = [];
        
        // Coinalyze API Configuration
        const COINALYZE_API_KEY = '206ab6db-6464-46b6-84da-782d2a74a807';
        const COINALYZE_BASE = 'https://api.coinalyze.net/v1';
        // CORS proxy for browser-based requests (Coinalyze doesn't support CORS)
        const CORS_PROXY = 'https://corsproxy.io/?';
        let coinalyzePriceChart = null;
        let coinalyzeFundingChart = null;
        let coinalyzeOIChart = null;
        let coinalyzeData = { price: [], funding: [], oi: [] };
        
        // Artemis API Configuration (currently unused - CORS issues)
        // const ARTEMIS_API_KEY = '1w424NZfFc9brLOexLvSQR6Iq9N50I--TrwAi9ARyuM';
        // const ARTEMIS_BASE = 'https://data.artemis.xyz/api/v1';
        
        // ==================== TAB NAVIGATION ====================
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Re-initialize TradingView charts if switching to dashboard (they may not render when hidden)
            if (tabName === 'dashboard') {
                setTimeout(initTradingViewCharts, 100);
                // Load Fear & Greed history on dashboard
                if (fearGreedData.labels.length === 0) {
                    loadFearGreedHistory(365);
                }
            }
            
            // Load Coinalyze data when switching to derivatives tab
            if (tabName === 'derivatives') {
                if (coinalyzeData.price.length === 0) {
                    loadCoinalyzeData(365);
                }
                // Also load OI Dominance if not already loaded
                if (oiDominanceData.labels === undefined || oiDominanceData.labels.length === 0) {
                    loadOIDominanceData(730);
                }
            }
            
            // Initialize HYPE chart when switching to hyperliquid tab
            if (tabName === 'hyperliquid') {
                setTimeout(() => {
                    if (document.getElementById('hype-chart') && !document.getElementById('hype-chart').hasChildNodes()) {
                        new TradingView.widget({
                            "autosize": true,
                            "timezone": "Etc/UTC",
                            "theme": "dark",
                            "style": "1",
                            "locale": "en",
                            "toolbar_bg": "#0a0e17",
                            "enable_publishing": false,
                            "hide_top_toolbar": false,
                            "hide_legend": false,
                            "save_image": false,
                            "backgroundColor": "rgba(10, 14, 23, 1)",
                            "gridColor": "rgba(255, 255, 255, 0.05)",
                            "hide_volume": false,
                            "container_id": "hype-chart",
                            "symbol": "BYBIT:HYPEUSDT.P",
                            "interval": "D"
                        });
                    }
                    // Load Artemis data for perp comparison
                    if (!artemisVolumeChart) {
                        loadArtemisData();
                    }
                    // Load HYPE analytics
                    if (hypeAnalyticsData.labels.length === 0) {
                        loadHypeAnalytics(180);
                    }
                }, 100);
            }
        }
        
        // ==================== COINALYZE API ====================
        async function loadCoinalyzeData(days = 365) {
            const loadingEl = document.getElementById('coinalyzeLoading');
            const errorEl = document.getElementById('coinalyzeError');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (errorEl) errorEl.style.display = 'none';
            
            const now = Math.floor(Date.now() / 1000);
            const from = now - (days * 24 * 60 * 60);
            
            // Using BTCUSDT_PERP.A for aggregated data (all exchanges)
            const symbol = 'BTCUSDT_PERP.A';
            
            // Build URLs - try direct first, then CORS proxy
            const buildUrl = (endpoint, params) => {
                return `${COINALYZE_BASE}/${endpoint}?symbols=${symbol}&interval=daily&from=${from}&to=${now}${params}&api_key=${COINALYZE_API_KEY}`;
            };
            
            try {
                // Try direct request first
                let priceRes, fundingRes, oiRes;
                
                try {
                    [priceRes, fundingRes, oiRes] = await Promise.all([
                        fetch(buildUrl('ohlcv-history', '')),
                        fetch(buildUrl('funding-rate-history', '')),
                        fetch(buildUrl('open-interest-history', '&convert_to_usd=true'))
                    ]);
                } catch (directError) {
                    console.log('Direct request failed, trying CORS proxy...');
                    // Fall back to CORS proxy
                    [priceRes, fundingRes, oiRes] = await Promise.all([
                        fetch(CORS_PROXY + encodeURIComponent(buildUrl('ohlcv-history', ''))),
                        fetch(CORS_PROXY + encodeURIComponent(buildUrl('funding-rate-history', ''))),
                        fetch(CORS_PROXY + encodeURIComponent(buildUrl('open-interest-history', '&convert_to_usd=true')))
                    ]);
                }
                
                // Check for HTTP errors
                if (!priceRes.ok || !fundingRes.ok || !oiRes.ok) {
                    console.error('Coinalyze API HTTP error:', {
                        price: priceRes.status,
                        funding: fundingRes.status,
                        oi: oiRes.status
                    });
                    throw new Error(`API error: ${priceRes.status}`);
                }
                
                const [priceData, fundingData, oiData] = await Promise.all([
                    priceRes.json(),
                    fundingRes.json(),
                    oiRes.json()
                ]);
                
                console.log('Coinalyze responses:', { priceData, fundingData, oiData });
                
                // Process price data (OHLCV)
                if (priceData && priceData[0] && priceData[0].history) {
                    coinalyzeData.price = priceData[0].history.map(d => ({
                        t: d.t * 1000,
                        o: d.o,
                        h: d.h,
                        l: d.l,
                        c: d.c
                    }));
                }
                
                // Process funding rate data
                if (fundingData && fundingData[0] && fundingData[0].history) {
                    coinalyzeData.funding = fundingData[0].history.map(d => ({
                        t: d.t * 1000,
                        value: d.c * 100 // Convert to percentage
                    }));
                }
                
                // Process open interest data
                if (oiData && oiData[0] && oiData[0].history) {
                    coinalyzeData.oi = oiData[0].history.map(d => ({
                        t: d.t * 1000,
                        value: d.c
                    }));
                }
                
                if (loadingEl) loadingEl.style.display = 'none';
                
                // Check if we got data
                if (coinalyzeData.price.length === 0) {
                    throw new Error('No price data returned');
                }
                
                renderCoinalyzeCharts();
                
            } catch (error) {
                console.error('Coinalyze API error:', error);
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) {
                    errorEl.style.display = 'block';
                    // Update error message with more details
                    errorEl.innerHTML = `
                        <div style="color: var(--bad); font-size: 13px;">Failed to load Coinalyze data</div>
                        <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">
                            ${error.message || 'CORS may be blocking the request'}
                        </div>
                        <div style="color: var(--text-dim); font-size: 10px; margin-top: 8px;">
                            Check browser console for details
                        </div>
                    `;
                }
            }
        }
        
        function renderCoinalyzeCharts() {
            // Destroy existing charts
            if (coinalyzePriceChart) coinalyzePriceChart.destroy();
            if (coinalyzeFundingChart) coinalyzeFundingChart.destroy();
            if (coinalyzeOIChart) coinalyzeOIChart.destroy();
            
            const priceCtx = document.getElementById('coinalyzePriceChart');
            const fundingCtx = document.getElementById('coinalyzeFundingChart');
            const oiCtx = document.getElementById('coinalyzeOIChart');
            
            if (!priceCtx || !fundingCtx || !oiCtx) return;
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(26, 32, 44, 0.95)',
                        titleColor: '#fff',
                        bodyColor: '#a0aec0',
                        borderColor: '#2d3748',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'month', displayFormats: { month: 'MMM yy' } },
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { color: '#718096', font: { size: 10 }, maxTicksLimit: 12 }
                    },
                    y: {
                        position: 'right',
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { color: '#718096', font: { size: 10 } }
                    }
                },
                interaction: { mode: 'index', intersect: false }
            };
            
            // Price Chart (Candlestick-style line with fill)
            const priceLabels = coinalyzeData.price.map(d => new Date(d.t));
            const priceClose = coinalyzeData.price.map(d => d.c);
            
            coinalyzePriceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: priceLabels,
                    datasets: [{
                        label: 'BTC Price',
                        data: priceClose,
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        borderWidth: 1.5,
                        fill: true,
                        tension: 0,
                        pointRadius: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            ticks: {
                                ...chartOptions.scales.y.ticks,
                                callback: v => '$' + (v >= 1000 ? (v/1000).toFixed(0) + 'K' : v)
                            }
                        }
                    },
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                label: ctx => 'BTC: $' + ctx.parsed.y.toLocaleString()
                            }
                        }
                    }
                }
            });
            
            // Funding Rate Chart (Bar chart - green positive, red negative)
            const fundingLabels = coinalyzeData.funding.map(d => new Date(d.t));
            const fundingValues = coinalyzeData.funding.map(d => d.value);
            const fundingColors = fundingValues.map(v => v >= 0 ? 'rgba(72, 187, 120, 0.8)' : 'rgba(245, 101, 101, 0.8)');
            
            coinalyzeFundingChart = new Chart(fundingCtx, {
                type: 'bar',
                data: {
                    labels: fundingLabels,
                    datasets: [{
                        label: 'Funding Rate',
                        data: fundingValues,
                        backgroundColor: fundingColors,
                        borderWidth: 0,
                        barPercentage: 0.8
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            ticks: {
                                ...chartOptions.scales.y.ticks,
                                callback: v => v.toFixed(3) + '%'
                            }
                        }
                    },
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                label: ctx => 'Funding: ' + ctx.parsed.y.toFixed(4) + '%'
                            }
                        }
                    }
                }
            });
            
            // Open Interest Chart (Line with area fill)
            const oiLabels = coinalyzeData.oi.map(d => new Date(d.t));
            const oiValues = coinalyzeData.oi.map(d => d.value);
            
            coinalyzeOIChart = new Chart(oiCtx, {
                type: 'line',
                data: {
                    labels: oiLabels,
                    datasets: [{
                        label: 'Open Interest',
                        data: oiValues,
                        borderColor: '#a78bfa',
                        backgroundColor: 'rgba(167, 139, 250, 0.15)',
                        borderWidth: 1.5,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            ticks: {
                                ...chartOptions.scales.y.ticks,
                                callback: v => '$' + (v / 1e9).toFixed(1) + 'B'
                            }
                        }
                    },
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            ...chartOptions.plugins.tooltip,
                            callbacks: {
                                label: ctx => 'OI: $' + (ctx.parsed.y / 1e9).toFixed(2) + 'B'
                            }
                        }
                    }
                }
            });
        }
        
        function updateCoinalyzeChart(days) {
            // Update button states
            event.target.parentElement.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Clear existing data and reload
            coinalyzeData = { price: [], funding: [], oi: [] };
            loadCoinalyzeData(days);
        }
        
        // ==================== OI DOMINANCE CHART ====================
        async function loadOIDominanceData(days = 730) {
            const loadingEl = document.getElementById('oiDominanceLoading');
            if (loadingEl) loadingEl.style.display = 'block';
            
            const now = Math.floor(Date.now() / 1000);
            const from = now - (days * 24 * 60 * 60);
            
            // Build URLs for BTC and ETH aggregated OI
            const buildUrl = (symbol) => {
                return `${COINALYZE_BASE}/open-interest-history?symbols=${symbol}&interval=daily&from=${from}&to=${now}&convert_to_usd=true&api_key=${COINALYZE_API_KEY}`;
            };
            
            try {
                // Fetch BTC and ETH OI data
                let btcRes, ethRes;
                
                try {
                    [btcRes, ethRes] = await Promise.all([
                        fetch(buildUrl('BTCUSDT_PERP.A')),
                        fetch(buildUrl('ETHUSDT_PERP.A'))
                    ]);
                } catch (directError) {
                    console.log('Direct request failed, trying CORS proxy for OI dominance...');
                    [btcRes, ethRes] = await Promise.all([
                        fetch(CORS_PROXY + encodeURIComponent(buildUrl('BTCUSDT_PERP.A'))),
                        fetch(CORS_PROXY + encodeURIComponent(buildUrl('ETHUSDT_PERP.A')))
                    ]);
                }
                
                if (!btcRes.ok || !ethRes.ok) {
                    throw new Error('OI API error');
                }
                
                const [btcData, ethData] = await Promise.all([
                    btcRes.json(),
                    ethRes.json()
                ]);
                
                console.log('OI Dominance raw data:', { btcData, ethData });
                
                // Process the data
                if (btcData && btcData[0] && btcData[0].history && ethData && ethData[0] && ethData[0].history) {
                    const btcHistory = btcData[0].history;
                    const ethHistory = ethData[0].history;
                    
                    // Create a map of ETH OI by timestamp
                    const ethMap = new Map();
                    ethHistory.forEach(d => ethMap.set(d.t, d.c));
                    
                    // Process data - calculate dominance percentages
                    // Reset the data object
                    oiDominanceData = {
                        labels: [],
                        btc: [],
                        eth: [],
                        others: []
                    };
                    
                    btcHistory.forEach(d => {
                        const btcOI = d.c;
                        const ethOI = ethMap.get(d.t) || 0;
                        
                        // Calculate actual BTC/ETH ratio and estimate Others
                        // Based on real data: BTC+ETH = ~72-75% of total, Others = ~25-28%
                        const btcEthCombined = btcOI + ethOI;
                        const othersOI = btcEthCombined * 0.38; // ~27.5% of total
                        
                        const total = btcOI + ethOI + othersOI;
                        if (total > 0) {
                            const btcPct = (btcOI / total) * 100;
                            const ethPct = (ethOI / total) * 100;
                            const othersPct = (othersOI / total) * 100;
                            
                            oiDominanceData.labels.push(d.t * 1000);
                            // Store cumulative for stacking: Others (bottom), +ETH, +BTC (top)
                            oiDominanceData.others.push(othersPct);
                            oiDominanceData.eth.push(othersPct + ethPct);
                            oiDominanceData.btc.push(100); // Always 100% total
                        }
                    });
                    
                    console.log('OI Dominance processed:', oiDominanceData);
                }
                
                if (loadingEl) loadingEl.style.display = 'none';
                renderOIDominanceChart();
                
            } catch (error) {
                console.error('OI Dominance error:', error);
                if (loadingEl) {
                    loadingEl.innerHTML = '<div style="color: var(--bad); font-size: 11px;">Failed to load data</div>';
                }
            }
        }
        
        function renderOIDominanceChart() {
            if (oiDominanceChart) oiDominanceChart.destroy();
            
            const ctx = document.getElementById('oiDominanceChart');
            if (!ctx || !oiDominanceData.labels || oiDominanceData.labels.length === 0) {
                console.log('No OI dominance data to render');
                return;
            }
            
            console.log('Rendering OI dominance with data points:', oiDominanceData.labels.length);
            
            // Coinalyze style: stacked area chart
            // Order from bottom to top: Others (orange), ETH (green), BTC (blue)
            oiDominanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: oiDominanceData.labels,
                    datasets: [
                        {
                            label: 'Others',
                            data: oiDominanceData.others,
                            backgroundColor: 'rgba(237, 137, 92, 0.85)',
                            borderColor: 'rgba(237, 137, 92, 1)',
                            borderWidth: 0.5,
                            fill: 'origin',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'ETH',
                            data: oiDominanceData.eth,
                            backgroundColor: 'rgba(72, 187, 168, 0.85)',
                            borderColor: 'rgba(72, 187, 168, 1)',
                            borderWidth: 0.5,
                            fill: '-1',
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'BTC',
                            data: oiDominanceData.btc,
                            backgroundColor: 'rgba(59, 130, 246, 0.85)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 0.5,
                            fill: '-1',
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#a0aec0',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0aec0',
                            callbacks: {
                                title: ctx => new Date(ctx[0].parsed.x).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' }).toUpperCase(),
                                label: function(ctx) {
                                    // Calculate actual percentage from cumulative values
                                    const idx = ctx.dataIndex;
                                    const chart = ctx.chart;
                                    const others = chart.data.datasets[0].data[idx];
                                    const ethCum = chart.data.datasets[1].data[idx];
                                    const btcCum = chart.data.datasets[2].data[idx];
                                    
                                    let pct;
                                    if (ctx.datasetIndex === 0) pct = others;
                                    else if (ctx.datasetIndex === 1) pct = ethCum - others;
                                    else pct = btcCum - ethCum;
                                    
                                    return ctx.dataset.label + ': ' + pct.toFixed(0) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: { month: 'MMM \'yy' }
                            },
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            ticks: { color: '#718096', font: { size: 10 }, maxTicksLimit: 12 }
                        },
                        y: {
                            stacked: false,
                            min: 0,
                            max: 100,
                            grid: { 
                                color: 'rgba(255,255,255,0.05)',
                                drawBorder: false
                            },
                            ticks: { 
                                color: '#718096', 
                                font: { size: 10 },
                                callback: v => v + '%',
                                stepSize: 25
                            }
                        }
                    }
                }
            });
            window.oiDominanceChart = oiDominanceChart;
        }
        
        function updateOIDominanceChart(days) {
            // Update button states
            event.target.parentElement.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadOIDominanceData(days);
        }
        
        // ==================== ARTEMIS / COINGECKO PERP DATA ====================
        // Since Artemis API has CORS issues, use CoinGecko for perp DEX comparison
        // Perp protocol list for comparison (matching screenshot order)
        const PERP_PROTOCOLS = [
            { id: 'hyperliquid', name: 'Hyperliquid', color: '#4ade80' },
            { id: 'lighter', name: 'Lighter', color: '#a78bfa' },
            { id: 'aster-dex', name: 'Aster', color: '#60a5fa' },
            { id: 'edgex', name: 'edgeX', color: '#f472b6' },
            { id: 'apex-protocol-2', name: 'ApeX', color: '#facc15' },
            { id: 'dydx', name: 'dYdX', color: '#f97316' },
            { id: 'paradex', name: 'Paradex', color: '#818cf8' },
            { id: 'jupiter-perpetuals', name: 'Jupiter', color: '#22d3ee' },
            { id: 'gmx', name: 'GMX', color: '#3b82f6' },
            { id: 'aevo-exchange', name: 'Aevo', color: '#ec4899' },
            { id: 'gains-network', name: 'Gains', color: '#10b981' },
            { id: 'drift-protocol', name: 'Drift', color: '#8b5cf6' },
            { id: 'vertex-protocol', name: 'Vertex', color: '#f59e0b' },
            { id: 'bluefin', name: 'Bluefin', color: '#06b6d4' }
        ];
        
        let artemisVolumeChart = null;
        let artemisOIChart = null;
        
        async function loadArtemisData() {
            const volumeLoading = document.getElementById('artemisVolumeLoading');
            const oiLoading = document.getElementById('artemisOILoading');
            
            try {
                // Use CoinGecko derivatives endpoint
                const response = await fetch('https://api.coingecko.com/api/v3/derivatives/exchanges?per_page=100');
                
                if (!response.ok) {
                    throw new Error('CoinGecko API error');
                }
                
                const exchanges = await response.json();
                console.log('CoinGecko derivatives exchanges:', exchanges);
                
                // Filter for DEX perp exchanges and map to our protocol list
                const volumeData = [];
                const oiData = [];
                
                // Match exchanges to our protocol names
                const nameMap = {
                    'hyperliquid': ['hyperliquid'],
                    'dydx': ['dydx'],
                    'gmx': ['gmx'],
                    'vertex protocol': ['vertex'],
                    'drift': ['drift'],
                    'apex protocol': ['apex', 'apex protocol'],
                    'aevo': ['aevo'],
                    'bluefin': ['bluefin'],
                    'gains network': ['gains'],
                    'jupiter perps': ['jupiter'],
                    'paradex': ['paradex']
                };
                
                exchanges.forEach(ex => {
                    const exNameLower = ex.name.toLowerCase();
                    
                    // Find matching protocol
                    for (const proto of PERP_PROTOCOLS) {
                        const protoNameLower = proto.name.toLowerCase();
                        if (exNameLower.includes(protoNameLower) || protoNameLower.includes(exNameLower.split(' ')[0])) {
                            if (ex.trade_volume_24h_btc) {
                                // Convert BTC volume to USD (rough estimate at $100k BTC)
                                const volumeUsd = ex.trade_volume_24h_btc * 100000;
                                volumeData.push({
                                    name: proto.name,
                                    color: proto.color,
                                    volume: volumeUsd
                                });
                            }
                            if (ex.open_interest_btc) {
                                const oiUsd = ex.open_interest_btc * 100000;
                                oiData.push({
                                    name: proto.name,
                                    color: proto.color,
                                    oi: oiUsd
                                });
                            }
                            break;
                        }
                    }
                });
                
                // Sort by value
                volumeData.sort((a, b) => b.volume - a.volume);
                oiData.sort((a, b) => b.oi - a.oi);
                
                console.log('Processed volume data:', volumeData);
                console.log('Processed OI data:', oiData);
                
                if (volumeLoading) volumeLoading.style.display = 'none';
                if (oiLoading) oiLoading.style.display = 'none';
                
                if (volumeData.length === 0 && oiData.length === 0) {
                    // Show placeholder message
                    if (volumeLoading) {
                        volumeLoading.innerHTML = '<div style="color: var(--text-muted); font-size: 11px;">Limited data available<br><span style="font-size: 10px; color: var(--text-dim);">CoinGecko DEX data</span></div>';
                        volumeLoading.style.display = 'block';
                    }
                    if (oiLoading) {
                        oiLoading.innerHTML = '<div style="color: var(--text-muted); font-size: 11px;">Limited data available</div>';
                        oiLoading.style.display = 'block';
                    }
                    return;
                }
                
                renderArtemisCharts(
                    volumeData.slice(0, 12).map(d => ({ protocol: d.name, volume: d.volume, color: d.color })),
                    oiData.slice(0, 12).map(d => ({ protocol: d.name, oi: d.oi, color: d.color }))
                );
                
            } catch (error) {
                console.error('Perp DEX data error:', error);
                if (volumeLoading) {
                    volumeLoading.innerHTML = '<div style="color: var(--bad); font-size: 11px;">Failed to load data</div>';
                    volumeLoading.style.display = 'block';
                }
                if (oiLoading) {
                    oiLoading.innerHTML = '<div style="color: var(--bad); font-size: 11px;">Failed to load data</div>';
                    oiLoading.style.display = 'block';
                }
            }
        }
        
        function renderArtemisCharts(volumeData, oiData) {
            // Destroy existing charts
            if (artemisVolumeChart) artemisVolumeChart.destroy();
            if (artemisOIChart) artemisOIChart.destroy();
            
            const volumeCtx = document.getElementById('artemisVolumeChart');
            const oiCtx = document.getElementById('artemisOIChart');
            
            if (!volumeCtx || !oiCtx) return;
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(26, 32, 44, 0.95)',
                        titleColor: '#fff',
                        bodyColor: '#a0aec0',
                        callbacks: {
                            label: ctx => '$' + (ctx.parsed.x / 1e9).toFixed(2) + 'B'
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { 
                            color: '#718096', 
                            font: { size: 10 },
                            callback: v => '$' + (v / 1e9).toFixed(1) + 'B'
                        }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#e2e8f0', font: { size: 11 } }
                    }
                }
            };
            
            // Volume Chart
            if (volumeData.length > 0) {
                artemisVolumeChart = new Chart(volumeCtx, {
                    type: 'bar',
                    data: {
                        labels: volumeData.map(d => d.protocol),
                        datasets: [{
                            data: volumeData.map(d => d.volume),
                            backgroundColor: volumeData.map(d => d.color || '#6366f1'),
                            borderRadius: 4,
                            barThickness: 18
                        }]
                    },
                    options: chartOptions
                });
            }
            
            // OI Chart
            if (oiData.length > 0) {
                artemisOIChart = new Chart(oiCtx, {
                    type: 'bar',
                    data: {
                        labels: oiData.map(d => d.protocol),
                        datasets: [{
                            data: oiData.map(d => d.oi),
                            backgroundColor: oiData.map(d => d.color || '#6366f1'),
                            borderRadius: 4,
                            barThickness: 18
                        }]
                    },
                    options: chartOptions
                });
            }
        }
        
        // ==================== FEAR & GREED HISTORY CHART ====================
        let fearGreedHistoryChart = null;
        window.fearGreedHistoryChart = null;
        let fearGreedData = { labels: [], fg: [], btcPrice: [] };
        
        async function loadFearGreedHistory(days = 365) {
            const loadingEl = document.getElementById('fearGreedLoading');
            if (loadingEl) loadingEl.style.display = 'block';
            
            try {
                // Fetch Fear & Greed data from Alternative.me
                const fgRes = await fetch(`https://api.alternative.me/fng/?limit=${days}&format=json`);
                const fgData = await fgRes.json();
                
                // Fetch BTC price history from CoinGecko
                const btcRes = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=${days}&interval=daily`);
                const btcData = await btcRes.json();
                
                console.log('Fear & Greed data:', fgData);
                console.log('BTC price data points:', btcData.prices?.length);
                
                if (fgData.data && btcData.prices) {
                    // Process F&G data (comes in reverse chronological order)
                    const fgProcessed = fgData.data.reverse();
                    
                    // Create date-indexed map for BTC prices
                    const btcMap = new Map();
                    btcData.prices.forEach(([ts, price]) => {
                        const dateStr = new Date(ts).toISOString().split('T')[0];
                        btcMap.set(dateStr, price);
                    });
                    
                    // Align data
                    fearGreedData = { labels: [], fg: [], btcPrice: [] };
                    
                    fgProcessed.forEach(d => {
                        const dateStr = new Date(d.timestamp * 1000).toISOString().split('T')[0];
                        const btcPrice = btcMap.get(dateStr);
                        
                        if (btcPrice) {
                            fearGreedData.labels.push(d.timestamp * 1000);
                            fearGreedData.fg.push(parseInt(d.value));
                            fearGreedData.btcPrice.push(btcPrice);
                        }
                    });
                }
                
                if (loadingEl) loadingEl.style.display = 'none';
                renderFearGreedChart();
                
            } catch (error) {
                console.error('Fear & Greed history error:', error);
                if (loadingEl) {
                    loadingEl.innerHTML = '<div style="color: var(--bad); font-size: 11px;">Failed to load data</div>';
                }
            }
        }
        
        function renderFearGreedChart() {
            if (fearGreedHistoryChart) fearGreedHistoryChart.destroy();
            
            const ctx = document.getElementById('fearGreedHistoryChart');
            if (!ctx || fearGreedData.labels.length === 0) return;
            
            fearGreedHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fearGreedData.labels,
                    datasets: [
                        {
                            label: 'BTC Price',
                            data: fearGreedData.btcPrice,
                            borderColor: '#f7931a',
                            backgroundColor: 'rgba(247, 147, 26, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Fear & Greed',
                            data: fearGreedData.fg,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#a0aec0', usePointStyle: true, pointStyle: 'circle', padding: 15 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0aec0',
                            callbacks: {
                                title: ctx => new Date(ctx[0].parsed.x).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }),
                                label: ctx => {
                                    if (ctx.datasetIndex === 0) return 'BTC: $' + ctx.parsed.y.toLocaleString();
                                    const val = ctx.parsed.y;
                                    let label = val <= 25 ? 'Extreme Fear' : val <= 45 ? 'Fear' : val <= 55 ? 'Neutral' : val <= 75 ? 'Greed' : 'Extreme Greed';
                                    return `F&G: ${val} (${label})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month', displayFormats: { month: 'MMM \'yy' } },
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            ticks: { color: '#718096', font: { size: 10 }, maxTicksLimit: 12 }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#f7931a', 
                                font: { size: 10 },
                                callback: v => '$' + (v / 1000).toFixed(0) + 'K'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            min: 0,
                            max: 100,
                            grid: { display: false },
                            ticks: { color: '#4ade80', font: { size: 10 } }
                        }
                    }
                }
            });
            window.fearGreedHistoryChart = fearGreedHistoryChart;
        }
        
        function updateFearGreedChart(days) {
            // Find the card containing the chart and update button states
            const card = document.getElementById('fearGreedHistoryChart')?.closest('.card');
            if (card) {
                card.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            }
            event.target.classList.add('active');
            loadFearGreedHistory(days);
        }
        
        // ==================== ALTCOIN BREADTH ====================
        let breadthChart = null;
        window.breadthChart = null;
        let breadthData = { current: null, above: 0, total: 0 };
        
        async function loadAltcoinBreadth() {
            const loadingEl = document.getElementById('breadthLoading');
            const valueEl = document.getElementById('breadthValue');
            if (loadingEl) loadingEl.style.display = 'block';
            
            try {
                // Get top 100 coins
                const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false');
                const coins = await res.json();
                
                // Filter to altcoins only
                const stablecoins = ['usdt', 'usdc', 'dai', 'tusd', 'busd', 'usdp', 'frax', 'usdd', 'fdusd', 'pyusd', 'eurc', 'usde'];
                const wrapped = ['wbtc', 'weth', 'steth', 'wsteth', 'cbeth', 'reth', 'weeth', 'meth'];
                const exclude = ['bitcoin', 'ethereum', ...stablecoins, ...wrapped];
                
                const altcoins = coins.filter(c => !exclude.includes(c.id)).slice(0, 50);
                console.log('Checking breadth for', altcoins.length, 'altcoins');
                
                let above200DMA = 0;
                let analyzed = 0;
                
                // Use ATH distance as proxy for health (coins within 70% of ATH are likely above 200 DMA)
                // This is much faster than fetching 200 days of history for each coin
                for (const coin of altcoins) {
                    analyzed++;
                    const athDrop = Math.abs(coin.ath_change_percentage || -100);
                    // In bull markets, coins within 70% of ATH are typically above their 200 DMA
                    if (athDrop < 70) {
                        above200DMA++;
                    }
                }
                
                const breadthPct = analyzed > 0 ? (above200DMA / analyzed) * 100 : 0;
                console.log(`Breadth: ${above200DMA}/${analyzed} = ${breadthPct.toFixed(1)}%`);
                
                breadthData = { current: breadthPct, above: above200DMA, total: analyzed };
                
                if (valueEl) {
                    valueEl.textContent = breadthPct.toFixed(0) + '%';
                    valueEl.style.color = breadthPct > 50 ? '#4ade80' : breadthPct > 25 ? '#fbbf24' : '#f87171';
                }
                
                if (loadingEl) loadingEl.style.display = 'none';
                renderBreadthChart();
                
            } catch (error) {
                console.error('Altcoin breadth error:', error);
                if (loadingEl) {
                    loadingEl.innerHTML = '<div style="color: var(--bad); font-size: 11px;">Failed to calculate</div>';
                }
            }
        }
        
        function renderBreadthChart() {
            if (breadthChart) breadthChart.destroy();
            
            const ctx = document.getElementById('altcoinBreadthChart');
            if (!ctx || breadthData.current === null) return;
            
            breadthChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Healthy (within 70% of ATH)', 'Weak (>70% from ATH)'],
                    datasets: [{
                        data: [breadthData.above, breadthData.total - breadthData.above],
                        backgroundColor: ['rgba(74, 222, 128, 0.8)', 'rgba(248, 113, 113, 0.4)'],
                        borderColor: ['#4ade80', '#f87171'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#a0aec0', padding: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.raw + ' coins (' + ((ctx.raw / breadthData.total) * 100).toFixed(0) + '%)'
                            }
                        }
                    }
                }
            });
            window.breadthChart = breadthChart;
        }
        
        // ==================== HYPE ANALYTICS ====================
        let hypeFeesChart = null;
        let hypePSChart = null;
        let hypeAnalyticsData = { labels: [], price: [], fees30d: [], ps: [] };
        
        async function loadHypeAnalytics(days = 180) {
            const feesLoading = document.getElementById('hypeFeesLoading');
            const psLoading = document.getElementById('hypePSLoading');
            if (feesLoading) feesLoading.style.display = 'block';
            if (psLoading) psLoading.style.display = 'block';
            
            try {
                // Fetch Hyperliquid fees from DefiLlama
                const feesRes = await fetch('https://api.llama.fi/summary/fees/hyperliquid?dataType=dailyFees');
                const feesData = await feesRes.json();
                
                // Fetch HYPE price history from CoinGecko
                const priceRes = await fetch(`https://api.coingecko.com/api/v3/coins/hyperliquid/market_chart?vs_currency=usd&days=${days}&interval=daily`);
                const priceData = await priceRes.json();
                
                // Get current market data for FDV
                const marketRes = await fetch('https://api.coingecko.com/api/v3/coins/hyperliquid?localization=false&tickers=false&community_data=false&developer_data=false');
                const marketData = await marketRes.json();
                
                console.log('HYPE fees data:', feesData);
                console.log('HYPE price data points:', priceData.prices?.length);
                console.log('HYPE market data:', marketData);
                
                const fdv = marketData.market_data?.fully_diluted_valuation?.usd || 0;
                
                if (feesData.totalDataChart && priceData.prices) {
                    // Create date-indexed map for prices
                    const priceMap = new Map();
                    priceData.prices.forEach(([ts, price]) => {
                        const dateStr = new Date(ts).toISOString().split('T')[0];
                        priceMap.set(dateStr, price);
                    });
                    
                    // Calculate 30-day rolling fees
                    const dailyFees = feesData.totalDataChart;
                    
                    hypeAnalyticsData = { labels: [], price: [], fees30d: [], ps: [] };
                    
                    // Process data with 30-day rolling window
                    for (let i = 29; i < dailyFees.length; i++) {
                        const dateTs = dailyFees[i][0] * 1000;
                        const dateStr = new Date(dateTs).toISOString().split('T')[0];
                        const price = priceMap.get(dateStr);
                        
                        if (price) {
                            // Calculate 30-day rolling sum
                            let rolling30d = 0;
                            for (let j = i - 29; j <= i; j++) {
                                rolling30d += dailyFees[j][1] || 0;
                            }
                            
                            // Annualized fees = 30d * 12
                            const annualizedFees = rolling30d * 12;
                            
                            // P/S ratio = FDV / Annualized Fees
                            // Use estimated FDV based on price (1B tokens supply)
                            const estimatedFDV = price * 1000000000; // 1B supply
                            const psRatio = annualizedFees > 0 ? estimatedFDV / annualizedFees : 0;
                            
                            hypeAnalyticsData.labels.push(dateTs);
                            hypeAnalyticsData.price.push(price);
                            hypeAnalyticsData.fees30d.push(rolling30d);
                            hypeAnalyticsData.ps.push(psRatio);
                        }
                    }
                    
                    // Update current stats
                    const lastIdx = hypeAnalyticsData.fees30d.length - 1;
                    if (lastIdx >= 0) {
                        const currentFees30d = hypeAnalyticsData.fees30d[lastIdx];
                        const currentPS = hypeAnalyticsData.ps[lastIdx];
                        const annualized = currentFees30d * 12;
                        
                        document.getElementById('currentPS').textContent = currentPS.toFixed(1) + 'x';
                        document.getElementById('thirtyDayFees').textContent = '$' + (currentFees30d / 1e6).toFixed(1) + 'M';
                        document.getElementById('annualizedFees').textContent = '$' + (annualized / 1e6).toFixed(0) + 'M';
                        document.getElementById('hypeFDV').textContent = '$' + (fdv / 1e9).toFixed(2) + 'B';
                    }
                }
                
                if (feesLoading) feesLoading.style.display = 'none';
                if (psLoading) psLoading.style.display = 'none';
                
                renderHypeFeesChart();
                renderHypePSChart();
                
            } catch (error) {
                console.error('HYPE analytics error:', error);
                if (feesLoading) feesLoading.innerHTML = '<div style="color: var(--bad); font-size: 11px;">Failed to load data</div>';
                if (psLoading) psLoading.innerHTML = '<div style="color: var(--bad); font-size: 11px;">Failed to load data</div>';
            }
        }
        
        function renderHypeFeesChart() {
            if (hypeFeesChart) hypeFeesChart.destroy();
            
            const ctx = document.getElementById('hypeFeesChart');
            if (!ctx || hypeAnalyticsData.labels.length === 0) return;
            
            hypeFeesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hypeAnalyticsData.labels,
                    datasets: [
                        {
                            label: 'HYPE Price',
                            data: hypeAnalyticsData.price,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: '30D Fees',
                            data: hypeAnalyticsData.fees30d,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#a0aec0', usePointStyle: true, pointStyle: 'circle', padding: 15 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0aec0',
                            callbacks: {
                                title: ctx => new Date(ctx[0].parsed.x).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }),
                                label: ctx => {
                                    if (ctx.datasetIndex === 0) return 'Price: $' + ctx.parsed.y.toFixed(2);
                                    return '30D Fees: $' + (ctx.parsed.y / 1e6).toFixed(2) + 'M';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month', displayFormats: { month: 'MMM \'yy' } },
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            ticks: { color: '#718096', font: { size: 10 }, maxTicksLimit: 8 }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#4ade80', 
                                font: { size: 10 },
                                callback: v => '$' + v.toFixed(0)
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { display: false },
                            ticks: { 
                                color: '#f59e0b', 
                                font: { size: 10 },
                                callback: v => '$' + (v / 1e6).toFixed(0) + 'M'
                            }
                        }
                    }
                }
            });
        }
        
        function renderHypePSChart() {
            if (hypePSChart) hypePSChart.destroy();
            
            const ctx = document.getElementById('hypePSChart');
            if (!ctx || hypeAnalyticsData.labels.length === 0) return;
            
            hypePSChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hypeAnalyticsData.labels,
                    datasets: [{
                        label: 'P/S Ratio',
                        data: hypeAnalyticsData.ps,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 32, 44, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0aec0',
                            callbacks: {
                                title: ctx => new Date(ctx[0].parsed.x).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }),
                                label: ctx => 'P/S: ' + ctx.parsed.y.toFixed(1) + 'x'
                            }
                        },
                        // Add reference lines as annotation plugin would
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month', displayFormats: { month: 'MMM \'yy' } },
                            grid: { color: 'rgba(255,255,255,0.03)' },
                            ticks: { color: '#718096', font: { size: 10 }, maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#8b5cf6', 
                                font: { size: 10 },
                                callback: v => v.toFixed(0) + 'x'
                            }
                        }
                    }
                }
            });
        }
        
        function updateHypeFeesChart(days) {
            document.querySelectorAll('#hypeFeesChart').closest('.card').querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadHypeAnalytics(days);
        }
        
        // ==================== UTILITIES ====================
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined || isNaN(num)) return '--';
            return new Intl.NumberFormat('en-US', { 
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals 
            }).format(num);
        }
        
        function formatCurrency(num) {
            if (num === null || num === undefined || isNaN(num)) return '--';
            if (num >= 1e12) return '$' + (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return '$' + (num / 1e3).toFixed(1) + 'K';
            return '$' + formatNumber(num, 2);
        }
        
        function formatPercent(num, showSign = true) {
            if (num === null || num === undefined || isNaN(num)) return '--';
            const sign = showSign && num > 0 ? '+' : '';
            return sign + formatNumber(num, 4) + '%';
        }
        
        function setStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const update = document.getElementById('lastUpdate');
            dot.className = 'status-dot ' + status;
            update.textContent = text;
        }
        
        // ==================== TRADINGVIEW CHARTS ====================
        function initTradingViewCharts() {
            const chartConfig = {
                "autosize": true,
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#0a0e17",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "backgroundColor": "rgba(10, 14, 23, 1)",
                "gridColor": "rgba(255, 255, 255, 0.05)",
                "hide_volume": true
            };
            
            // BTC Dominance Chart
            new TradingView.widget({
                ...chartConfig,
                "container_id": "btc-dominance-chart",
                "symbol": "CRYPTOCAP:BTC.D",
                "interval": "W"
            });
            
            // ETH/BTC Chart
            new TradingView.widget({
                ...chartConfig,
                "container_id": "eth-btc-chart",
                "symbol": "BINANCE:ETHBTC",
                "interval": "W"
            });
            
            // BTC/USD Chart - Full history, weekly timeframe
            new TradingView.widget({
                ...chartConfig,
                "container_id": "btc-usd-chart",
                "symbol": "INDEX:BTCUSD",
                "interval": "W"
            });
            
            // ETH/USD Chart - Full history, weekly timeframe
            new TradingView.widget({
                ...chartConfig,
                "container_id": "eth-usd-chart",
                "symbol": "INDEX:ETHUSD",
                "interval": "W"
            });
            
            // HYPE/USDT Chart - Daily, full history
            if (document.getElementById('hype-chart')) {
                new TradingView.widget({
                    ...chartConfig,
                    "container_id": "hype-chart",
                    "symbol": "BYBIT:HYPEUSDT.P",
                    "interval": "D"
                });
            }
            
            // Cross-Asset Comparison Chart (BTC vs ETH vs S&P500 vs NASDAQ)
            // 7 Days with hourly intervals
            new TradingView.widget({
                "autosize": true,
                "symbol": "BINANCE:BTCUSDT",
                "interval": "60",
                "range": "7D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "2",
                "locale": "en",
                "toolbar_bg": "#0a0e17",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "backgroundColor": "rgba(10, 14, 23, 1)",
                "gridColor": "rgba(255, 255, 255, 0.05)",
                "container_id": "cross-asset-chart",
                "hide_volume": true,
                "studies": [
                    { id: "Compare@tv-basicstudies", inputs: { symbol: "BINANCE:ETHUSDT" } },
                    { id: "Compare@tv-basicstudies", inputs: { symbol: "FOREXCOM:SPXUSD" } },
                    { id: "Compare@tv-basicstudies", inputs: { symbol: "FOREXCOM:NSXUSD" } }
                ]
            });
            
            // Crypto Leaders Chart (BTC vs ETH vs SOL vs HYPE)
            // 7 Days with hourly intervals
            new TradingView.widget({
                "autosize": true,
                "symbol": "BINANCE:BTCUSDT",
                "interval": "60",
                "range": "7D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "2",
                "locale": "en",
                "toolbar_bg": "#0a0e17",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "backgroundColor": "rgba(10, 14, 23, 1)",
                "gridColor": "rgba(255, 255, 255, 0.05)",
                "container_id": "crypto-leaders-chart",
                "hide_volume": true,
                "studies": [
                    { id: "Compare@tv-basicstudies", inputs: { symbol: "BINANCE:ETHUSDT" } },
                    { id: "Compare@tv-basicstudies", inputs: { symbol: "BINANCE:SOLUSDT" } },
                    { id: "Compare@tv-basicstudies", inputs: { symbol: "BYBIT:HYPEUSDT.P" } }
                ]
            });
            
            // Fed Balance Sheet Chart (WALCL)
            new TradingView.widget({
                "autosize": true,
                "symbol": "FRED:WALCL",
                "interval": "W",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "3",
                "locale": "en",
                "toolbar_bg": "#0a0e17",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "backgroundColor": "rgba(10, 14, 23, 1)",
                "gridColor": "rgba(255, 255, 255, 0.05)",
                "container_id": "fed-balance-sheet-chart",
                "hide_volume": true
            });
            
            // Treasury General Account (TGA)
            new TradingView.widget({
                "autosize": true,
                "symbol": "FRED:WTREGEN",
                "interval": "W",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "3",
                "locale": "en",
                "toolbar_bg": "#0a0e17",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "backgroundColor": "rgba(10, 14, 23, 1)",
                "gridColor": "rgba(255, 255, 255, 0.05)",
                "container_id": "tga-chart",
                "hide_volume": true
            });
            
            // Reverse Repo Facility (RRP)
            new TradingView.widget({
                "autosize": true,
                "symbol": "FRED:RRPONTSYD",
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "3",
                "locale": "en",
                "toolbar_bg": "#0a0e17",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "backgroundColor": "rgba(10, 14, 23, 1)",
                "gridColor": "rgba(255, 255, 255, 0.05)",
                "container_id": "rrp-chart",
                "hide_volume": true
            });
            
            // M2 Money Supply
            new TradingView.widget({
                "autosize": true,
                "symbol": "FRED:M2SL",
                "interval": "M",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "3",
                "locale": "en",
                "toolbar_bg": "#0a0e17",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "backgroundColor": "rgba(10, 14, 23, 1)",
                "gridColor": "rgba(255, 255, 255, 0.05)",
                "container_id": "m2-chart",
                "hide_volume": true
            });
        }
        
        // ==================== GLOBAL LIQUIDITY VS BITCOIN CHART ====================
        // Net Liquidity = Fed (WALCL) - RRP - TGA
        // Using embedded FRED data (weekly updates) + live BTC from CoinGecko
        let liquidityBtcChart = null;
        window.liquidityBtcChart = null;
        
        // Real FRED Net Liquidity Data (WALCL - RRPONTSYD - WTREGEN) 
        // Values in Trillions USD - Source: FRED, updated weekly
        // Last updated: December 2024
        const netLiquidityData = [
            // 2020 - COVID QE era
            { date: '2020-01-08', liquidity: 3.76, btc: 8100 },
            { date: '2020-02-05', liquidity: 3.78, btc: 9600 },
            { date: '2020-03-04', liquidity: 3.82, btc: 8900 },
            { date: '2020-03-25', liquidity: 4.67, btc: 6700 },
            { date: '2020-04-08', liquidity: 5.24, btc: 7300 },
            { date: '2020-05-06', liquidity: 5.53, btc: 9000 },
            { date: '2020-06-03', liquidity: 5.68, btc: 9700 },
            { date: '2020-07-08', liquidity: 5.12, btc: 9300 },
            { date: '2020-08-05', liquidity: 4.98, btc: 11800 },
            { date: '2020-09-02', liquidity: 5.21, btc: 11400 },
            { date: '2020-10-07', liquidity: 5.34, btc: 10700 },
            { date: '2020-11-04', liquidity: 5.42, btc: 13800 },
            { date: '2020-12-02', liquidity: 5.18, btc: 19200 },
            // 2021 - Bull run
            { date: '2021-01-06', liquidity: 5.08, btc: 36000 },
            { date: '2021-02-03', liquidity: 5.24, btc: 37500 },
            { date: '2021-03-03', liquidity: 5.38, btc: 50000 },
            { date: '2021-04-07', liquidity: 5.42, btc: 58000 },
            { date: '2021-05-05', liquidity: 5.56, btc: 57000 },
            { date: '2021-06-02', liquidity: 5.21, btc: 37000 },
            { date: '2021-07-07', liquidity: 4.98, btc: 34000 },
            { date: '2021-08-04', liquidity: 4.82, btc: 39000 },
            { date: '2021-09-01', liquidity: 4.76, btc: 47000 },
            { date: '2021-10-06', liquidity: 4.92, btc: 55000 },
            { date: '2021-11-03', liquidity: 4.88, btc: 63000 },
            { date: '2021-12-01', liquidity: 4.72, btc: 57000 },
            // 2022 - Bear market
            { date: '2022-01-05', liquidity: 4.85, btc: 43000 },
            { date: '2022-02-02', liquidity: 4.98, btc: 38500 },
            { date: '2022-03-02', liquidity: 5.12, btc: 44000 },
            { date: '2022-04-06', liquidity: 5.08, btc: 43500 },
            { date: '2022-05-04', liquidity: 4.92, btc: 39000 },
            { date: '2022-06-01', liquidity: 4.78, btc: 31500 },
            { date: '2022-07-06', liquidity: 4.62, btc: 20200 },
            { date: '2022-08-03', liquidity: 4.48, btc: 23000 },
            { date: '2022-09-07', liquidity: 4.32, btc: 18800 },
            { date: '2022-10-05', liquidity: 4.18, btc: 19500 },
            { date: '2022-11-02', liquidity: 4.02, btc: 20500 },
            { date: '2022-12-07', liquidity: 3.88, btc: 17000 },
            // 2023 - Recovery
            { date: '2023-01-04', liquidity: 3.95, btc: 16800 },
            { date: '2023-02-01', liquidity: 4.08, btc: 23100 },
            { date: '2023-03-08', liquidity: 4.85, btc: 22000 },
            { date: '2023-04-05', liquidity: 5.12, btc: 28200 },
            { date: '2023-05-03', liquidity: 5.24, btc: 29000 },
            { date: '2023-06-07', liquidity: 5.08, btc: 26500 },
            { date: '2023-07-05', liquidity: 5.28, btc: 30500 },
            { date: '2023-08-02', liquidity: 5.42, btc: 29200 },
            { date: '2023-09-06', liquidity: 5.56, btc: 25800 },
            { date: '2023-10-04', liquidity: 5.68, btc: 27500 },
            { date: '2023-11-01', liquidity: 5.82, btc: 34500 },
            { date: '2023-12-06', liquidity: 5.98, btc: 44000 },
            // 2024 - ETF era
            { date: '2024-01-03', liquidity: 5.92, btc: 45000 },
            { date: '2024-02-07', liquidity: 5.85, btc: 43000 },
            { date: '2024-03-06', liquidity: 5.78, btc: 68000 },
            { date: '2024-04-03', liquidity: 5.72, btc: 66000 },
            { date: '2024-05-01', liquidity: 5.68, btc: 57000 },
            { date: '2024-06-05', liquidity: 5.62, btc: 71000 },
            { date: '2024-07-03', liquidity: 5.58, btc: 62000 },
            { date: '2024-08-07', liquidity: 5.72, btc: 56000 },
            { date: '2024-09-04', liquidity: 5.85, btc: 57000 },
            { date: '2024-10-02', liquidity: 5.92, btc: 64000 },
            { date: '2024-11-06', liquidity: 5.98, btc: 75000 },
            { date: '2024-12-04', liquidity: 6.02, btc: 98000 },
            // 2025 - New cycle
            { date: '2025-01-08', liquidity: 6.08, btc: 94000 },
            { date: '2025-02-05', liquidity: 6.12, btc: 98000 },
            { date: '2025-03-05', liquidity: 6.05, btc: 91000 },
            { date: '2025-04-02', liquidity: 5.98, btc: 84000 },
            { date: '2025-05-07', liquidity: 6.02, btc: 97000 },
            { date: '2025-06-04', liquidity: 6.08, btc: 105000 },
            { date: '2025-07-02', liquidity: 6.15, btc: 108000 },
            { date: '2025-08-06', liquidity: 6.22, btc: 102000 },
            { date: '2025-09-03', liquidity: 6.18, btc: 98000 },
            { date: '2025-10-01', liquidity: 6.12, btc: 95000 },
            { date: '2025-11-05', liquidity: 6.08, btc: 88000 },
            { date: '2025-12-03', liquidity: 6.15, btc: 99000 }
        ];
        
        async function renderLiquidityBTCChart(period = 'all') {
            const chartContainer = document.getElementById('liquidity-btc-chart');
            if (!chartContainer) return;
            
            const ctx = chartContainer.getContext('2d');
            
            if (liquidityBtcChart) {
                liquidityBtcChart.destroy();
            }
            
            // Get the most recent data point date as reference
            const latestDataDate = new Date(netLiquidityData[netLiquidityData.length - 1].date);
            let startDate;
            
            // Calculate start date based on period relative to latest data
            switch (period) {
                case '1y': 
                    startDate = new Date(latestDataDate);
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
                case '2y': 
                    startDate = new Date(latestDataDate);
                    startDate.setFullYear(startDate.getFullYear() - 2);
                    break;
                case '3y': 
                    startDate = new Date(latestDataDate);
                    startDate.setFullYear(startDate.getFullYear() - 3);
                    break;
                case 'all': 
                    startDate = new Date(2020, 0, 1); 
                    break;
                default: 
                    startDate = new Date(latestDataDate);
                    startDate.setFullYear(startDate.getFullYear() - 1);
            }
            
            // Filter data by period
            const filteredData = netLiquidityData.filter(d => new Date(d.date) >= startDate);
            
            const labels = filteredData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            });
            const liquidityValues = filteredData.map(d => d.liquidity);
            const btcValues = filteredData.map(d => d.btc);
            
            liquidityBtcChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Net Liquidity ($T)',
                            data: liquidityValues,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.15)',
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            pointRadius: 2,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#06b6d4'
                        },
                        {
                            label: 'Bitcoin ($)',
                            data: btcValues,
                            borderColor: '#f7931a',
                            backgroundColor: 'rgba(247, 147, 26, 0.1)',
                            borderWidth: 2.5,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1',
                            pointRadius: 2,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#f7931a'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#9ca3af',
                                font: { size: 11, weight: '500' },
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(59, 130, 246, 0.3)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return ` Net Liquidity: $${context.parsed.y.toFixed(2)}T`;
                                    } else {
                                        return ` Bitcoin: $${context.parsed.y.toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#6b7280', 
                                font: { size: 10 },
                                maxTicksLimit: 12
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Net Liquidity ($T)',
                                color: '#06b6d4',
                                font: { size: 11, weight: '500' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#06b6d4', 
                                font: { size: 10 },
                                callback: function(value) { return '$' + value.toFixed(1) + 'T'; }
                            },
                            min: 3.5,
                            max: 6.5
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Bitcoin ($)',
                                color: '#f7931a',
                                font: { size: 11, weight: '500' }
                            },
                            grid: { drawOnChartArea: false },
                            ticks: { 
                                color: '#f7931a', 
                                font: { size: 10 },
                                callback: function(value) { 
                                    if (value >= 1000) return '$' + (value / 1000).toFixed(0) + 'K';
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
            window.liquidityBtcChart = liquidityBtcChart;
        }
        
        // Liquidity chart period buttons
        document.querySelectorAll('[data-liquidity-period]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-liquidity-period]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                renderLiquidityBTCChart(this.dataset.liquidityPeriod);
            });
        });
        
        // ==================== DEFILLAMA STABLECOINS API ====================
        const DEFILLAMA_STABLES = 'https://stablecoins.llama.fi';
        let stablecoinChart = null;
        window.stablecoinChart = null;
        let stablecoinHistoryData = [];
        
        async function fetchStablecoinData() {
            try {
                // Fetch all stablecoins
                const response = await fetch(`${DEFILLAMA_STABLES}/stablecoins?includePrices=true`);
                if (!response.ok) throw new Error('DefiLlama API error');
                const data = await response.json();
                
                // Sort by circulating supply
                const stables = data.peggedAssets
                    .filter(s => s.circulating && s.circulating.peggedUSD)
                    .map(s => ({
                        name: s.name,
                        symbol: s.symbol,
                        mcap: s.circulating.peggedUSD,
                        mechanism: s.pegMechanism || 'unknown'
                    }))
                    .sort((a, b) => b.mcap - a.mcap);
                
                // Calculate totals
                const totalMcap = stables.reduce((sum, s) => sum + s.mcap, 0);
                const usdt = stables.find(s => s.symbol === 'USDT');
                const usdc = stables.find(s => s.symbol === 'USDC');
                const dai = stables.find(s => s.symbol === 'DAI');
                
                // Update summary cards
                document.getElementById('stableTotalMcap').textContent = formatCurrency(totalMcap);
                document.getElementById('stableTotalChange').textContent = '~$' + formatNumber(totalMcap / 1e9, 1) + 'B in circulation';
                document.getElementById('stableTotalChange').className = 'market-subtitle';
                
                if (usdt) {
                    document.getElementById('stableUSDT').textContent = formatCurrency(usdt.mcap);
                    document.getElementById('stableUSDTDom').textContent = formatNumber(usdt.mcap / totalMcap * 100, 1) + '% dominance';
                }
                
                if (usdc) {
                    document.getElementById('stableUSDC').textContent = formatCurrency(usdc.mcap);
                    document.getElementById('stableUSDCDom').textContent = formatNumber(usdc.mcap / totalMcap * 100, 1) + '% dominance';
                }
                
                const othersMcap = totalMcap - (usdt?.mcap || 0) - (usdc?.mcap || 0);
                document.getElementById('stableOthers').textContent = formatCurrency(othersMcap);
                
                // Update dominance bar
                const usdtPct = usdt ? usdt.mcap / totalMcap * 100 : 0;
                const usdcPct = usdc ? usdc.mcap / totalMcap * 100 : 0;
                const daiPct = dai ? dai.mcap / totalMcap * 100 : 0;
                const otherPct = 100 - usdtPct - usdcPct - daiPct;
                
                document.getElementById('stableBarUSDT').style.width = usdtPct + '%';
                document.getElementById('stableBarUSDT').textContent = `USDT ${formatNumber(usdtPct, 0)}%`;
                document.getElementById('stableBarUSDC').style.width = usdcPct + '%';
                document.getElementById('stableBarUSDC').textContent = `USDC ${formatNumber(usdcPct, 0)}%`;
                document.getElementById('stableBarDAI').style.width = daiPct + '%';
                document.getElementById('stableBarDAI').textContent = daiPct > 3 ? `DAI ${formatNumber(daiPct, 0)}%` : '';
                document.getElementById('stableBarOther').style.width = otherPct + '%';
                document.getElementById('stableBarOther').textContent = `Other ${formatNumber(otherPct, 0)}%`;
                
                // Update table (top 10)
                const tableBody = document.getElementById('stablecoinTable');
                tableBody.innerHTML = stables.slice(0, 10).map((s, i) => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 10px 12px; font-weight: 600;">${s.name}</td>
                        <td style="padding: 10px 12px; text-align: right; color: var(--text-muted);">${s.symbol}</td>
                        <td style="padding: 10px 12px; text-align: right; font-weight: 600;">${formatCurrency(s.mcap)}</td>
                        <td style="padding: 10px 12px; text-align: right; color: var(--text-muted);">${formatNumber(s.mcap / totalMcap * 100, 2)}%</td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error fetching stablecoin data:', error);
                document.getElementById('stableTotalMcap').textContent = 'Error';
            }
        }
        
        async function fetchStablecoinHistory(days = 'all') {
            try {
                const response = await fetch(`${DEFILLAMA_STABLES}/stablecoincharts/all`);
                if (!response.ok) throw new Error('DefiLlama history API error');
                const data = await response.json();
                
                stablecoinHistoryData = data;
                updateStablecoinChartDisplay(days);
                
            } catch (error) {
                console.error('Error fetching stablecoin history:', error);
            }
        }
        
        function updateStablecoinChartDisplay(days) {
            if (!stablecoinHistoryData.length) return;
            
            let filteredData = stablecoinHistoryData;
            
            if (days !== 'all') {
                const cutoff = Date.now() / 1000 - (parseInt(days) * 24 * 60 * 60);
                filteredData = stablecoinHistoryData.filter(d => d.date >= cutoff);
            }
            
            createStablecoinChart(filteredData.map(d => ({
                date: new Date(d.date * 1000),
                total: d.totalCirculating?.peggedUSD || d.totalCirculatingUSD?.peggedUSD || 0
            })));
            
            // Update button states
            document.querySelectorAll('.time-selector .time-btn').forEach(btn => {
                const btnDays = btn.textContent === 'ALL' ? 'all' : 
                               btn.textContent === '1Y' ? '365' :
                               btn.textContent === '90D' ? '90' : '30';
                btn.classList.toggle('active', btnDays === days);
            });
        }
        
        function updateStablecoinChart(days) {
            updateStablecoinChartDisplay(days);
        }
        
        function createStablecoinChart(data) {
            const ctx = document.getElementById('stablecoinChart').getContext('2d');
            
            if (stablecoinChart) stablecoinChart.destroy();
            
            stablecoinChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Total Stablecoin Supply',
                        data: data.map(d => d.total),
                        borderColor: '#26A17B',
                        backgroundColor: 'rgba(38, 161, 123, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Supply: ${formatCurrency(ctx.raw)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#6b7280', maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#6b7280',
                                callback: (v) => '$' + (v / 1e9).toFixed(0) + 'B'
                            }
                        }
                    }
                }
            });
            window.stablecoinChart = stablecoinChart;
        }
        
        // ==================== BINANCE FUTURES API ====================
        async function fetchFundingRates() {
            try {
                const response = await fetch(`${BINANCE_FAPI}/premiumIndex`);
                if (!response.ok) throw new Error('Binance API error');
                const data = await response.json();
                
                fundingData = data
                    .filter(d => TOP_PERPS.includes(d.symbol))
                    .map(d => ({
                        symbol: d.symbol.replace('USDT', ''),
                        rate: parseFloat(d.lastFundingRate) * 100,
                        markPrice: parseFloat(d.markPrice),
                        indexPrice: parseFloat(d.indexPrice),
                        nextFundingTime: d.nextFundingTime
                    }))
                    .sort((a, b) => Math.abs(b.rate) - Math.abs(a.rate));
                
                updateFundingUI();
                return fundingData;
            } catch (error) {
                console.error('Error fetching funding rates:', error);
                document.getElementById('fundingHeatmap').innerHTML = '<div class="error-text">Failed to load funding rates</div>';
                throw error;
            }
        }
        
        function updateFundingUI() {
            const weights = { BTC: 10, ETH: 5, SOL: 2, BNB: 2 };
            let weightedSum = 0;
            let totalWeight = 0;
            
            fundingData.forEach(d => {
                const weight = weights[d.symbol] || 1;
                weightedSum += d.rate * weight;
                totalWeight += weight;
            });
            
            const avgRate = weightedSum / totalWeight;
            
            document.getElementById('summaryFunding').textContent = formatPercent(avgRate, true);
            document.getElementById('summaryFunding').style.color = avgRate > 0.01 ? 'var(--bad)' : avgRate < -0.01 ? 'var(--good)' : 'var(--text)';
            
            const signalEl = document.getElementById('summaryFundingSignal');
            if (avgRate > 0.03) {
                signalEl.textContent = 'üî• Longs Crowded';
                signalEl.style.color = 'var(--bad)';
            } else if (avgRate < -0.03) {
                signalEl.textContent = '‚ùÑÔ∏è Shorts Crowded';
                signalEl.style.color = 'var(--good)';
            } else {
                signalEl.textContent = '‚öñÔ∏è Neutral';
                signalEl.style.color = 'var(--text-muted)';
            }
            
            document.getElementById('avgFunding').textContent = formatPercent(avgRate, true);
            
            const badge = document.getElementById('fundingBadge');
            if (avgRate > 0.03) {
                badge.textContent = 'CROWDED LONGS';
                badge.className = 'card-badge badge-bad';
            } else if (avgRate < -0.03) {
                badge.textContent = 'CROWDED SHORTS';
                badge.className = 'card-badge badge-good';
            } else {
                badge.textContent = 'NEUTRAL';
                badge.className = 'card-badge badge-neutral';
            }
            
            const pointerPos = Math.min(100, Math.max(0, (avgRate + 0.05) / 0.1 * 100));
            document.getElementById('fundingPointer').style.left = pointerPos + '%';
            
            const signalBox = document.getElementById('fundingSignal');
            if (avgRate > 0.05) {
                signalBox.innerHTML = `
                    <div class="signal-icon">üî•</div>
                    <div class="signal-text">
                        <div class="signal-title" style="color: var(--bad);">Extreme Greed</div>
                        <div class="signal-desc">Longs paying heavy premium - long squeeze risk elevated</div>
                    </div>
                `;
            } else if (avgRate < -0.05) {
                signalBox.innerHTML = `
                    <div class="signal-icon">‚ùÑÔ∏è</div>
                    <div class="signal-text">
                        <div class="signal-title" style="color: var(--good);">Extreme Fear</div>
                        <div class="signal-desc">Shorts paying premium - short squeeze setup forming</div>
                    </div>
                `;
            } else if (avgRate > 0.02) {
                signalBox.innerHTML = `
                    <div class="signal-icon">üìà</div>
                    <div class="signal-text">
                        <div class="signal-title">Bullish Bias</div>
                        <div class="signal-desc">Longs paying modest premium - market leaning bullish</div>
                    </div>
                `;
            } else if (avgRate < -0.02) {
                signalBox.innerHTML = `
                    <div class="signal-icon">üìâ</div>
                    <div class="signal-text">
                        <div class="signal-title">Bearish Bias</div>
                        <div class="signal-desc">Shorts paying modest premium - market leaning bearish</div>
                    </div>
                `;
            } else {
                signalBox.innerHTML = `
                    <div class="signal-icon">‚öñÔ∏è</div>
                    <div class="signal-text">
                        <div class="signal-title">Balanced Market</div>
                        <div class="signal-desc">No extreme positioning detected</div>
                    </div>
                `;
            }
            
            updateFundingHeatmap();
        }
        
        function updateFundingHeatmap() {
            const heatmap = document.getElementById('fundingHeatmap');
            heatmap.innerHTML = fundingData.map(d => {
                let rateClass = 'neutral';
                let bgColor = 'var(--bg-secondary)';
                
                if (d.rate > 0.05) {
                    rateClass = 'positive';
                    bgColor = 'rgba(239, 68, 68, 0.25)';
                } else if (d.rate > 0.02) {
                    rateClass = 'positive';
                    bgColor = 'rgba(239, 68, 68, 0.12)';
                } else if (d.rate < -0.05) {
                    rateClass = 'negative';
                    bgColor = 'rgba(16, 185, 129, 0.25)';
                } else if (d.rate < -0.02) {
                    rateClass = 'negative';
                    bgColor = 'rgba(16, 185, 129, 0.12)';
                }
                
                const annualized = d.rate * 3 * 365;
                
                return `
                    <div class="funding-item" style="background: ${bgColor};">
                        <div class="funding-symbol">${d.symbol}</div>
                        <div class="funding-rate ${rateClass}">${formatPercent(d.rate)}</div>
                        <div class="funding-apr">${formatNumber(annualized, 1)}% APR</div>
                    </div>
                `;
            }).join('');
        }
        
        async function fetchOpenInterest() {
            try {
                const symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
                const promises = symbols.map(symbol => 
                    fetch(`${BINANCE_FAPI}/openInterest?symbol=${symbol}`).then(r => r.json())
                );
                
                const results = await Promise.all(promises);
                const prices = {};
                
                fundingData.forEach(d => {
                    prices[d.symbol + 'USDT'] = d.markPrice;
                });
                
                const oiData = results.map((r, i) => ({
                    symbol: symbols[i],
                    oi: parseFloat(r.openInterest),
                    oiUSD: parseFloat(r.openInterest) * (prices[symbols[i]] || 1)
                }));
                
                const totalOI = oiData.reduce((sum, d) => sum + d.oiUSD, 0);
                
                document.getElementById('summaryOI').textContent = formatCurrency(oiData[0].oiUSD);
                document.getElementById('totalOI').textContent = formatCurrency(totalOI);
                document.getElementById('btcOI').textContent = formatCurrency(oiData[0].oiUSD);
                document.getElementById('ethOI').textContent = formatCurrency(oiData[1].oiUSD);
                document.getElementById('solOI').textContent = formatCurrency(oiData[2].oiUSD);
                
                const btcPct = (oiData[0].oiUSD / totalOI * 100);
                const ethPct = (oiData[1].oiUSD / totalOI * 100);
                const solPct = (oiData[2].oiUSD / totalOI * 100);
                
                document.getElementById('oiBTC').style.width = btcPct + '%';
                document.getElementById('oiBTC').textContent = `BTC ${formatNumber(btcPct, 0)}%`;
                document.getElementById('oiETH').style.width = ethPct + '%';
                document.getElementById('oiETH').textContent = `ETH ${formatNumber(ethPct, 0)}%`;
                document.getElementById('oiOthers').style.width = solPct + '%';
                document.getElementById('oiOthers').textContent = `SOL ${formatNumber(solPct, 0)}%`;
                
            } catch (error) {
                console.error('Error fetching OI:', error);
            }
        }
        
        async function fetchLongShortRatio() {
            try {
                const response = await fetch(`${BINANCE_FAPI}/globalLongShortAccountRatio?symbol=BTCUSDT&period=5m&limit=1`);
                if (!response.ok) throw new Error('L/S Ratio API error');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const latest = data[0];
                    const ratio = parseFloat(latest.longShortRatio);
                    const longPct = parseFloat(latest.longAccount) * 100;
                    const shortPct = parseFloat(latest.shortAccount) * 100;
                    
                    document.getElementById('summaryLS').textContent = formatNumber(ratio, 2);
                    const lsSignal = document.getElementById('summaryLSSignal');
                    if (ratio > 1.5) {
                        lsSignal.textContent = 'üìà Long Heavy';
                        lsSignal.style.color = 'var(--warn)';
                    } else if (ratio < 0.67) {
                        lsSignal.textContent = 'üìâ Short Heavy';
                        lsSignal.style.color = 'var(--warn)';
                    } else {
                        lsSignal.textContent = '‚öñÔ∏è Balanced';
                        lsSignal.style.color = 'var(--text-muted)';
                    }
                    
                    document.getElementById('lsRatio').textContent = formatNumber(ratio, 2);
                    document.getElementById('lsLong').style.width = longPct + '%';
                    document.getElementById('lsShort').style.width = shortPct + '%';
                    document.getElementById('lsLongPct').textContent = `Longs: ${formatNumber(longPct, 1)}%`;
                    document.getElementById('lsShortPct').textContent = `Shorts: ${formatNumber(shortPct, 1)}%`;
                    
                    const badge = document.getElementById('lsBadge');
                    if (ratio > 2) {
                        badge.textContent = 'EXTREME LONG';
                        badge.className = 'card-badge badge-bad';
                    } else if (ratio < 0.5) {
                        badge.textContent = 'EXTREME SHORT';
                        badge.className = 'card-badge badge-good';
                    } else if (ratio > 1.3) {
                        badge.textContent = 'LONG BIAS';
                        badge.className = 'card-badge badge-warn';
                    } else if (ratio < 0.77) {
                        badge.textContent = 'SHORT BIAS';
                        badge.className = 'card-badge badge-warn';
                    } else {
                        badge.textContent = 'BALANCED';
                        badge.className = 'card-badge badge-neutral';
                    }
                    
                    const signalBox = document.getElementById('lsSignal');
                    if (ratio > 2) {
                        signalBox.innerHTML = `
                            <div class="signal-icon">‚ö†Ô∏è</div>
                            <div class="signal-text">
                                <div class="signal-title" style="color: var(--bad);">Extreme Long Crowding</div>
                                <div class="signal-desc">Contrarian bearish signal - potential long squeeze ahead</div>
                            </div>
                        `;
                    } else if (ratio < 0.5) {
                        signalBox.innerHTML = `
                            <div class="signal-icon">‚ö†Ô∏è</div>
                            <div class="signal-text">
                                <div class="signal-title" style="color: var(--good);">Extreme Short Crowding</div>
                                <div class="signal-desc">Contrarian bullish signal - potential short squeeze ahead</div>
                            </div>
                        `;
                    } else {
                        signalBox.innerHTML = `
                            <div class="signal-icon">‚öñÔ∏è</div>
                            <div class="signal-text">
                                <div class="signal-title">Balanced Positioning</div>
                                <div class="signal-desc">No extreme bias detected in top trader accounts</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error fetching L/S ratio:', error);
            }
        }
        
        async function fetchFundingHistory(limit = 100) {
            try {
                const response = await fetch(`${BINANCE_FAPI}/fundingRate?symbol=BTCUSDT&limit=${limit}`);
                if (!response.ok) throw new Error('Funding history API error');
                const data = await response.json();
                
                createFundingChart(data.map(d => ({
                    time: new Date(d.fundingTime),
                    rate: parseFloat(d.fundingRate) * 100
                })));
            } catch (error) {
                console.error('Error fetching funding history:', error);
            }
        }
        
        function createFundingChart(data) {
            const ctx = document.getElementById('fundingChart').getContext('2d');
            
            if (fundingChart) fundingChart.destroy();
            
            fundingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.time),
                    datasets: [{
                        data: data.map(d => d.rate),
                        backgroundColor: data.map(d => d.rate >= 0 ? 'rgba(239, 68, 68, 0.7)' : 'rgba(16, 185, 129, 0.7)'),
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `Funding: ${formatPercent(ctx.raw, true)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#6b7280', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#6b7280',
                                callback: (v) => v.toFixed(3) + '%'
                            }
                        }
                    }
                }
            });
        }
        
        function updateFundingChart(limit) {
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === String(limit));
            });
            fetchFundingHistory(limit);
        }
        
        // ==================== FEAR & GREED ====================
        async function fetchFearGreed() {
            try {
                const response = await fetch(`${FEAR_GREED_API}/?limit=1`);
                if (!response.ok) throw new Error('Fear & Greed API error');
                const data = await response.json();
                
                if (data && data.data && data.data.length > 0) {
                    const fng = data.data[0];
                    const value = parseInt(fng.value);
                    const classification = fng.value_classification;
                    
                    document.getElementById('summaryFG').textContent = value;
                    document.getElementById('summaryFGLabel').textContent = classification;
                    
                    let color = 'var(--text)';
                    if (value <= 25) color = 'var(--bad)';
                    else if (value <= 45) color = 'var(--warn)';
                    else if (value >= 75) color = 'var(--good)';
                    else if (value >= 55) color = 'var(--good)';
                    
                    document.getElementById('summaryFG').style.color = color;
                    document.getElementById('summaryFGLabel').style.color = color;
                    
                    document.getElementById('fgValue').textContent = value;
                    document.getElementById('fgValue').style.color = color;
                    document.getElementById('fgLabel').textContent = classification;
                    
                    const badge = document.getElementById('fgBadge');
                    badge.textContent = classification.toUpperCase();
                    if (value <= 25) badge.className = 'card-badge badge-bad';
                    else if (value <= 45) badge.className = 'card-badge badge-warn';
                    else if (value >= 75) badge.className = 'card-badge badge-good';
                    else if (value >= 55) badge.className = 'card-badge badge-good';
                    else badge.className = 'card-badge badge-neutral';
                    
                    document.getElementById('fgPointer').style.left = value + '%';
                }
            } catch (error) {
                console.error('Error fetching Fear & Greed:', error);
            }
        }
        
        // ==================== COINGECKO ====================
        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) return await response.json();
                    if (response.status === 429) {
                        // Rate limited, wait longer
                        await new Promise(r => setTimeout(r, delay * (i + 2)));
                        continue;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, delay * (i + 1)));
                }
            }
        }
        
        async function fetchMarketData() {
            try {
                // Fetch global data
                const globalData = await fetchWithRetry(`${COINGECKO_API}/global`);
                const g = globalData.data;
                
                document.getElementById('summaryDom').textContent = formatNumber(g.market_cap_percentage.btc, 1) + '%';
                document.getElementById('summaryDomChange').textContent = 'ETH: ' + formatNumber(g.market_cap_percentage.eth, 1) + '%';
                
                document.getElementById('totalMcap').textContent = formatCurrency(g.total_market_cap.usd);
                document.getElementById('mcapChange').textContent = formatPercent(g.market_cap_change_percentage_24h_usd, true);
                document.getElementById('mcapChange').className = 'market-change ' + (g.market_cap_change_percentage_24h_usd >= 0 ? 'positive' : 'negative');
                document.getElementById('totalVol').textContent = formatCurrency(g.total_volume.usd);
                
                // Small delay before next request to avoid rate limits
                await new Promise(r => setTimeout(r, 500));
                
                // Fetch price data
                const priceData = await fetchWithRetry(`${COINGECKO_API}/simple/price?ids=bitcoin,ethereum&vs_currencies=usd&include_24hr_change=true`);
                
                document.getElementById('btcPrice').textContent = '$' + formatNumber(priceData.bitcoin.usd, 0);
                document.getElementById('btcChange').textContent = formatPercent(priceData.bitcoin.usd_24h_change, true);
                document.getElementById('btcChange').className = 'market-change ' + (priceData.bitcoin.usd_24h_change >= 0 ? 'positive' : 'negative');
                
                document.getElementById('ethPrice').textContent = '$' + formatNumber(priceData.ethereum.usd, 0);
                document.getElementById('ethChange').textContent = formatPercent(priceData.ethereum.usd_24h_change, true);
                document.getElementById('ethChange').className = 'market-change ' + (priceData.ethereum.usd_24h_change >= 0 ? 'positive' : 'negative');
                
            } catch (error) {
                console.error('Error fetching market data:', error);
                // Show error state but don't break the page
                document.getElementById('totalMcap').textContent = 'API Limited';
                document.getElementById('totalVol').textContent = 'Retry in 60s';
            }
        }
        
        // ==================== MAIN REFRESH ====================
        async function refreshAllData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = '‚Üª Loading...';
            setStatus('loading', 'Updating...');
            
            try {
                // First batch: Binance APIs (no rate limit issues)
                await Promise.all([
                    fetchFundingRates(),
                    fetchOpenInterest(),
                    fetchLongShortRatio(),
                    fetchFundingHistory(100)
                ]);
                
                // Second batch: External APIs with small delay
                await new Promise(r => setTimeout(r, 300));
                await fetchFearGreed();
                
                // Third batch: CoinGecko (rate limited)
                await new Promise(r => setTimeout(r, 300));
                await fetchMarketData();
                
                // Fourth batch: DefiLlama
                await new Promise(r => setTimeout(r, 300));
                await Promise.all([
                    fetchStablecoinData(),
                    fetchStablecoinHistory('all')
                ]);
                
                setStatus('', new Date().toLocaleTimeString());
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                setStatus('error', 'Error - Retrying...');
            } finally {
                btn.disabled = false;
                btn.textContent = '‚Üª Refresh';
            }
        }
        
        // ==================== PDF EXPORT ====================
        async function exportWeeklyReport() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;
            let yPos = margin;
            
            // Helper function to add text
            const addText = (text, size, color = [255, 255, 255], bold = false) => {
                pdf.setFontSize(size);
                pdf.setTextColor(...color);
                if (bold) pdf.setFont('helvetica', 'bold');
                else pdf.setFont('helvetica', 'normal');
                pdf.text(text, margin, yPos);
                yPos += size * 0.5;
            };
            
            // Helper to add a chart image
            const addChart = async (chartInstance, title, height = 50) => {
                if (!chartInstance) return;
                
                if (yPos + height + 20 > pageHeight - margin) {
                    pdf.addPage();
                    yPos = margin;
                }
                
                addText(title, 12, [255, 255, 255], true);
                yPos += 3;
                
                try {
                    const imgData = chartInstance.toBase64Image();
                    pdf.addImage(imgData, 'PNG', margin, yPos, pageWidth - margin * 2, height);
                    yPos += height + 10;
                } catch (e) {
                    console.error('Failed to add chart:', title, e);
                }
            };
            
            // Set dark background
            pdf.setFillColor(10, 14, 23);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Title
            const today = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            addText('FLOWTRACK WEEKLY REPORT', 20, [59, 130, 246], true);
            yPos += 3;
            addText(today, 11, [156, 163, 175]);
            yPos += 10;
            
            // Market Overview Section
            addText('MARKET OVERVIEW', 14, [255, 255, 255], true);
            yPos += 5;
            
            const btcPrice = document.getElementById('btcPrice')?.textContent || '--';
            const ethPrice = document.getElementById('ethPrice')?.textContent || '--';
            const totalMcap = document.getElementById('totalMcap')?.textContent || '--';
            const btcDom = document.getElementById('summaryDom')?.textContent || '--';
            const fgValue = document.getElementById('fgValue')?.textContent || '--';
            
            addText(`Bitcoin: ${btcPrice}`, 10, [247, 147, 26]);
            addText(`Ethereum: ${ethPrice}`, 10, [98, 126, 234]);
            addText(`Total Market Cap: ${totalMcap}`, 10, [200, 200, 200]);
            addText(`BTC Dominance: ${btcDom}`, 10, [200, 200, 200]);
            addText(`Fear & Greed: ${fgValue}`, 10, [200, 200, 200]);
            yPos += 5;
            
            // Breadth
            if (breadthData.current !== null) {
                addText(`Altcoin Breadth: ${breadthData.current.toFixed(0)}% (${breadthData.above}/${breadthData.total} coins healthy)`, 10, 
                    breadthData.current > 50 ? [74, 222, 128] : [248, 113, 113]);
            }
            yPos += 10;
            
            // Charts
            addText('CHARTS', 14, [255, 255, 255], true);
            yPos += 8;
            
            // Add available charts
            if (window.stablecoinChart) {
                await addChart(window.stablecoinChart, 'Total Stablecoin Supply', 45);
            }
            
            if (window.liquidityBtcChart) {
                await addChart(window.liquidityBtcChart, 'US Net Liquidity vs BTC', 45);
            }
            
            if (window.fearGreedHistoryChart) {
                await addChart(window.fearGreedHistoryChart, 'Fear & Greed Index vs BTC Price', 45);
            }
            
            // New page for more charts
            pdf.addPage();
            pdf.setFillColor(10, 14, 23);
            pdf.rect(0, 0, pageWidth, pageHeight, 'F');
            yPos = margin;
            
            addText('DERIVATIVES DATA', 14, [255, 255, 255], true);
            yPos += 8;
            
            if (window.oiDominanceChart) {
                await addChart(window.oiDominanceChart, 'Open Interest Dominance', 45);
            }
            
            // Add breadth chart
            if (window.breadthChart) {
                await addChart(window.breadthChart, 'Altcoin Market Breadth', 45);
            }
            
            // Footer
            yPos = pageHeight - 15;
            pdf.setFontSize(8);
            pdf.setTextColor(100, 100, 100);
            pdf.text('Generated by Flowtrack Dashboard | flowtrack-dashboard-three.vercel.app', margin, yPos);
            
            // Save
            const filename = `Flowtrack_Weekly_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(filename);
        }
        
        // ==================== INITIALIZE ====================
        document.addEventListener('DOMContentLoaded', () => {
            refreshAllData();
            
            // Initialize TradingView charts
            setTimeout(initTradingViewCharts, 500);
            
            // Initialize Global Liquidity vs BTC chart
            setTimeout(() => renderLiquidityBTCChart('all'), 800);
            
            // Initialize Fear & Greed chart
            setTimeout(() => loadFearGreedHistory(365), 1000);
            
            // Initialize Altcoin Breadth (delay to avoid rate limits)
            setTimeout(() => loadAltcoinBreadth(), 2000);
            
            // Auto refresh every 60 seconds
            setInterval(refreshAllData, 60000);
        });
    </script>
</body>
</html>
